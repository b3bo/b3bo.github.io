<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ video.title }} - ManaMeter™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f3ffe8',
                            100: '#e5fecf',
                            200: '#ccfd9c',
                            300: '#b5fd5d',
                            400: '#92e800',
                            500: '#7dcf00',
                            600: '#61a500',
                            700: '#4b7d00',
                            800: '#3c6300',
                            900: '#36530f',
                            950: '#1a2e00'
                        },
                        neutral: {
                            50: '#fafafa',
                            100: '#f5f5f5',
                            200: '#e5e5e5',
                            300: '#d4d4d4',
                            400: '#a1a1a1',
                            500: '#737373',
                            600: '#525252',
                            700: '#404040',
                            800: '#262626',
                            900: '#171717',
                            950: '#0a0a0a'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Courier New', monospace;
        }
    </style>
    <script type="application/json" id="video-data">
        {{ video|tojson }}
    </script>
</head>
<body class="bg-neutral-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-neutral-800 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <a href="/" class="flex items-center text-neutral-400 hover:text-white transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back to Dashboard
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-lg bg-neutral-700 hover:bg-neutral-600 transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            {% if reprocessed %}
            <!-- Reprocessed Notification -->
            <div class="bg-primary-900 border border-primary-700 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-primary-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <div>
                        <h3 class="text-sm font-medium text-primary-200">Video Reprocessed</h3>
                        <p class="text-sm text-primary-300 mt-1">This video has been successfully re-analyzed with updated processing. Detailed scripture references are now available.</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Video Info -->
            <div class="bg-gray-800 shadow overflow-hidden sm:rounded-lg mb-6">
                <div class="px-4 py-5 sm:p-6">
                    <h1 class="text-lg font-bold text-white mb-2 break-words leading-tight">Top 10 Sermons: {{ video.title }}</h1>
                    <p class="text-gray-400 mb-4">{{ video.channel }}</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div>
                            <span class="text-gray-400">Video ID:</span>
                            <span class="text-white ml-2">{{ video.video_id }}</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Processed:</span>
                            <span class="text-white ml-2">{{ video.processed_at[:19] if video.processed_at else 'Unknown' }}</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Transcript Length:</span>
                            <span class="text-white ml-2">{{ video.transcript_length }} characters</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-neutral-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-primary-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-neutral-400 truncate">Total</dt>
                                    <dd class="text-lg font-medium text-white">{{ video.stats.total_matches }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-neutral-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-primary-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-neutral-400 truncate">Confirmed</dt>
                                    <dd class="text-lg font-medium text-white">{{ video.stats.scripture_references }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-neutral-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-primary-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-neutral-400 truncate">Suspect</dt>
                                    <dd class="text-lg font-medium text-white">{{ video.stats.suspect_references }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-neutral-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-primary-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-neutral-400 truncate">False Positives</dt>
                                    <dd class="text-lg font-medium text-white">{{ video.stats.false_positives }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="bg-neutral-800 shadow overflow-hidden sm:rounded-lg mb-6">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-white mb-4">Scripture References by Book</h3>
                    <canvas id="referencesChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Top Books Table -->
            <div class="bg-neutral-800 shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-white">Top Referenced Books</h3>
                    <p class="mt-1 max-w-2xl text-sm text-neutral-400">Books with the most Scripture references in this video. Click the arrow to expand and see references in context.</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-neutral-700">
                        <thead class="bg-neutral-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-300 uppercase tracking-wider w-16"></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-300 uppercase tracking-wider">Book</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-300 uppercase tracking-wider">Confirmed</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-300 uppercase tracking-wider">Suspect</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-300 uppercase tracking-wider">Total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-neutral-800 divide-y divide-neutral-700">
                            {% set book_data = [] %}
                            {% for book in video.counts %}
                                {% set total = video.counts[book] + video.suspect_counts[book] %}
                                {% if total > 0 %}
                                    {% set _ = book_data.append({'book': book, 'confirmed': video.counts[book], 'suspect': video.suspect_counts[book], 'total': total}) %}
                                {% endif %}
                            {% endfor %}
                            {% set sorted_books = book_data|sort(attribute='total', reverse=True) %}
                            
                            {% for book_info in sorted_books %}
                            <tr class="book-row" data-book="{{ book_info.book }}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <button class="expand-btn text-primary-400 hover:text-primary-300 transition-colors">
                                        <svg class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">{{ book_info.book }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-400">{{ book_info.confirmed }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-300">{{ book_info.suspect }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-400">{{ book_info.total }}</td>
                            </tr>
                            <tr class="references-row hidden" data-book="{{ book_info.book }}">
                                <td colspan="5" class="px-6 py-4">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-neutral-600">
                                            <thead class="bg-neutral-600">
                                                <tr>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-neutral-300 uppercase tracking-wider">Time</th>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-neutral-300 uppercase tracking-wider">Reference</th>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-neutral-300 uppercase tracking-wider">Verse</th>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-neutral-300 uppercase tracking-wider">Context</th>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-neutral-300 uppercase tracking-wider">Type</th>
                                                </tr>
                                            </thead>
                                            {% set book_refs = all_refs_by_book.get(book_info.book, []) %}
                                            <tbody class="bg-neutral-700 divide-y divide-neutral-600">
                                                {% for ref in book_refs %}
                                                <tr>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-400">
                                                        {{ ref.get('start', 0)|round(1) }}s
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-primary-400">
                                                        {{ book_info.book }}
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-neutral-300">
                                                        {{ ref.get('verse', 'N/A') }}
                                                    </td>
                                                    <td class="px-4 py-4 text-sm text-neutral-300 max-w-2xl whitespace-normal break-words">
                                                        "{{ ref.get('context', 'No context available') }}"
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap">
                                                        {% if ref.get('type') == 'suspect' %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                                                            Suspect
                                                        </span>
                                                        {% else %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                                                            Confirmed
                                                        </span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                                {% if not book_refs %}
                                                <tr>
                                                    <td colspan="5" class="px-4 py-8 text-center text-sm text-gray-400">
                                                        Position data not available for this book. Please re-analyze the video to see detailed scripture references with timestamps and context.
                                                    </td>
                                                </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            html.classList.remove('dark');
        }

        // Chart
        const videoData = JSON.parse(document.getElementById('video-data').textContent);
        const ctx = document.getElementById('referencesChart').getContext('2d');
        const bookCounts = videoData.counts;
        const suspectBookCounts = videoData.suspect_counts;
        
        // Bible book order for sorting
        const BIBLE_BOOKS = [
            "Genesis", "Exodus", "Leviticus", "Numbers", "Deuteronomy",
            "Joshua", "Judges", "Ruth", "1 Samuel", "2 Samuel",
            "1 Kings", "2 Kings", "1 Chronicles", "2 Chronicles",
            "Ezra", "Nehemiah", "Esther", "Job", "Psalms", "Proverbs",
            "Ecclesiastes", "Song of Solomon", "Isaiah", "Jeremiah",
            "Lamentations", "Ezekiel", "Daniel", "Hosea", "Joel",
            "Amos", "Obadiah", "Jonah", "Micah", "Nahum", "Habakkuk",
            "Zephaniah", "Haggai", "Zechariah", "Malachi",
            "Matthew", "Mark", "Luke", "John", "Acts", "Romans",
            "1 Corinthians", "2 Corinthians", "Galatians", "Ephesians",
            "Philippians", "Colossians", "1 Thessalonians", "2 Thessalonians",
            "1 Timothy", "2 Timothy", "Titus", "Philemon", "Hebrews",
            "James", "1 Peter", "2 Peter", "1 John", "2 John", "3 John",
            "Jude", "Revelation"
        ];
        
        const bookData = [];
        Object.keys(bookCounts).forEach(book => {
            const total = bookCounts[book] + (suspectBookCounts[book] || 0);
            if (total > 0) {
                bookData.push({
                    book: book,
                    confirmed: bookCounts[book],
                    suspect: suspectBookCounts[book] || 0,
                    order: BIBLE_BOOKS.indexOf(book)
                });
            }
        });
        
        // Sort by biblical order
        bookData.sort((a, b) => a.order - b.order);
        
        const labels = bookData.map(item => item.book);
        const confirmedData = bookData.map(item => item.confirmed);
        const suspectData = bookData.map(item => item.suspect);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Confirmed References',
                    data: confirmedData,
                    backgroundColor: '#7dcf00',
                    borderColor: '#61a500',
                    borderWidth: 1,
                    stack: 'references'
                }, {
                    label: 'Suspect References',
                    data: suspectData,
                    backgroundColor: '#b5fd5d',
                    borderColor: '#92e800',
                    borderWidth: 1,
                    stack: 'references'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            color: '#a1a1a1'
                        },
                        grid: {
                            color: '#404040'
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        grace: '10%',
                        ticks: {
                            color: '#a1a1a1'
                        },
                        grid: {
                            color: '#404040'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#9ca3af'
                        }
                    }
                }
            }
        });

        // Book expansion functionality
        let currentlyOpenBook = null;

        document.querySelectorAll('.expand-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const row = this.closest('.book-row');
                const book = row.dataset.book;
                const referencesRow = document.querySelector(`.references-row[data-book="${book}"]`);
                const arrow = this.querySelector('svg');

                // Close currently open book if different
                if (currentlyOpenBook && currentlyOpenBook !== book) {
                    const currentRow = document.querySelector(`.references-row[data-book="${currentlyOpenBook}"]`);
                    const currentArrow = document.querySelector(`.book-row[data-book="${currentlyOpenBook}"] .expand-btn svg`);
                    if (currentRow) {
                        currentRow.classList.add('hidden');
                        currentArrow.classList.remove('rotate-90');
                    }
                }

                // Toggle current book
                if (referencesRow.classList.contains('hidden')) {
                    referencesRow.classList.remove('hidden');
                    arrow.classList.add('rotate-90');
                    currentlyOpenBook = book;
                } else {
                    referencesRow.classList.add('hidden');
                    arrow.classList.remove('rotate-90');
                    currentlyOpenBook = null;
                }
            });
        });
    </script>

    <!-- Footer -->
    <footer class="bg-gray-800 mt-12">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <div class="text-center text-sm text-gray-400">
                <p>© 2025 ManaMeter™ by B3boBytes. All rights reserved.</p>
                <p class="mt-2">Disclaimer: This tool is for educational and analytical purposes only. It does not guarantee accuracy of scripture references or endorse any content.</p>
            </div>
        </div>
    </footer>
</body>
</html>