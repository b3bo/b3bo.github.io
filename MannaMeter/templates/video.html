<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>{{ video.title }} - MannaMeter™</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f3ffe8',
                            100: '#e5fecf',
                            200: '#ccfd9c',
                            300: '#b5fd5d',
                            400: '#92e800',
                            500: '#7dcf00',
                            600: '#61a500',
                            700: '#4b7d00',
                            800: '#3c6300',
                            900: '#36530f',
                            950: '#1a2e00'
                        },
                        neutral: {
                            50: '#fafafa',
                            100: '#f5f5f5',
                            200: '#e5e5e5',
                            300: '#d4d4d4',
                            400: '#a1a1a1',
                            500: '#737373',
                            600: '#525252',
                            700: '#404040',
                            800: '#262626',
                            900: '#171717',
                            950: '#0a0a0a'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Courier New', monospace;
        }
    </style>
    <script type="application/json" id="video-data">
        {{ video|tojson }}
    </script>
    <script type="application/json" id="refs-data">
        {{ all_refs_by_book|tojson }}
    </script>
</head>
<body class="bg-white text-neutral-950 dark:bg-neutral-900 dark:text-white min-h-screen">
    <!-- Header -->
    <header class="bg-neutral-100 dark:bg-neutral-800 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <a href="/" class="flex items-center text-neutral-600 dark:text-neutral-400 hover:text-neutral-950 dark:hover:text-white transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back to Dashboard
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-lg bg-neutral-300 hover:bg-neutral-200 dark:bg-neutral-700 dark:hover:bg-neutral-600 transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            {% if reprocessed %}
            <!-- Reprocessed Notification -->
            <div class="bg-primary-900 border border-primary-700 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-primary-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <div>
                        <h3 class="text-sm font-medium text-primary-200">Video Reprocessed</h3>
                        <p class="text-sm text-primary-300 mt-1">This video has been successfully re-analyzed with updated processing. Detailed scripture references are now available.</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Video Info -->
            <div class="bg-neutral-100 dark:bg-neutral-800 shadow overflow-hidden sm:rounded-lg mb-6">
                <div class="px-4 py-5 sm:p-6">
                    <h1 class="text-2xl font-semibold text-primary-400 mb-2 break-words leading-tight">
                        <a href="https://www.youtube.com/watch?v={{ video.video_id }}" target="_blank" class="hover:underline">{{ video.title }}</a>
                    </h1>
                    <p class="text-gray-600 dark:text-gray-400 mb-2">
                        {% if video.channel_url %}
                        <a href="{{ video.channel_url }}" target="_blank" class="hover:underline">
                            {{ video.channel }}{% if video.processed_at %}
                            {% set date_parts = video.processed_at[:10].split('-') %}
                            {% set month_names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                            {% set month_idx = date_parts[1]|int - 1 %}
                            , {{ month_names[month_idx] }} {{ date_parts[2] }}, {{ date_parts[0] }}
                            {% endif %}
                        </a>
                        {% else %}
                        {{ video.channel }}{% if video.processed_at %}
                        {% set date_parts = video.processed_at[:10].split('-') %}
                        {% set month_names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                        {% set month_idx = date_parts[1]|int - 1 %}
                        , {{ month_names[month_idx] }} {{ date_parts[2] }}, {{ date_parts[0] }}
                        {% endif %}
                        {% endif %}
                    </p>
                    <div class="flex items-center gap-3 mb-4">
                        <a href="https://twitter.com/intent/tweet?url=https://www.youtube.com/watch?v={{ video.video_id }}&text={{ video.title }}" target="_blank" class="text-neutral-500 hover:text-neutral-700 dark:text-neutral-400 dark:hover:text-neutral-200 transition-colors" title="Share on X">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        </a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.youtube.com/watch?v={{ video.video_id }}" target="_blank" class="text-neutral-500 hover:text-neutral-700 dark:text-neutral-400 dark:hover:text-neutral-200 transition-colors" title="Share on Facebook">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                        </a>
                        <a href="https://www.instagram.com/" target="_blank" class="text-neutral-500 hover:text-neutral-700 dark:text-neutral-400 dark:hover:text-neutral-200 transition-colors" title="Share on Instagram" onclick="navigator.clipboard.writeText('{{ video.title }} - https://www.youtube.com/watch?v={{ video.video_id }}'); alert('Link copied! Paste it in your Instagram story or post.');">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                        </a>
                        <a href="mailto:?subject={{ video.title }}&body=Check out this sermon: https://www.youtube.com/watch?v={{ video.video_id }}" class="text-neutral-500 hover:text-neutral-700 dark:text-neutral-400 dark:hover:text-neutral-200 transition-colors" title="Share via Email">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                        </a>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div>
                            <span class="text-neutral-600 dark:text-neutral-400">Video ID:</span>
                            <span class="text-neutral-950 dark:text-white ml-2">{{ video.video_id }}</span>
                        </div>
                        <div>
                            <span class="text-neutral-600 dark:text-neutral-400">Processed:</span>
                            <span class="text-neutral-950 dark:text-white ml-2">{{ video.processed_at[:19] if video.processed_at else 'Unknown' }}</span>
                        </div>
                        <div>
                            <span class="text-neutral-600 dark:text-neutral-400">Transcript Length:</span>
                            <span class="text-neutral-950 dark:text-white ml-2">{{ video.transcript_length }} characters</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-neutral-100 dark:bg-neutral-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-primary-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-neutral-600 dark:text-neutral-400 truncate">Total</dt>
                                    <dd class="text-lg font-semibold text-neutral-950 dark:text-white">{{ video.stats.total_matches }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-neutral-100 dark:bg-neutral-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-primary-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-neutral-600 dark:text-neutral-400 truncate">Confirmed</dt>
                                    <dd class="text-lg font-semibold text-neutral-950 dark:text-white">{{ video.stats.scripture_references }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-neutral-100 dark:bg-neutral-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-primary-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-neutral-600 dark:text-neutral-400 truncate">Suspect</dt>
                                    <dd class="text-lg font-semibold text-neutral-950 dark:text-white">{{ video.stats.suspect_references }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-neutral-100 dark:bg-neutral-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-primary-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-neutral-600 dark:text-neutral-400 truncate">False Positives</dt>
                                    <dd class="text-lg font-semibold text-neutral-950 dark:text-white">{{ video.stats.false_positives }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scripture References Timeline -->
            <div class="bg-neutral-100 dark:bg-neutral-800 shadow overflow-hidden sm:rounded-lg mb-6">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-semibold text-neutral-950 dark:text-white mb-4">Scripture References Timeline</h3>
                    <p class="mt-1 max-w-2xl text-sm text-neutral-600 dark:text-neutral-400 mb-4">All scripture references in chronological order from the video.</p>
                    <div id="timeline-content" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Timeline content will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Top Books Table -->
            <div class="bg-neutral-100 dark:bg-neutral-800 shadow overflow-hidden sm:rounded-lg mb-6">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-semibold text-neutral-950 dark:text-white mb-4">Scripture References by Book</h3>
                    <div style="height: 350px;">
                        <canvas id="referencesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Books Table -->
            <div class="bg-neutral-100 dark:bg-neutral-800 shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-lg leading-6 font-semibold text-neutral-950 dark:text-white">Top Referenced Books</h3>
                    <p class="mt-1 max-w-2xl text-sm text-neutral-600 dark:text-neutral-400">Books with the most Scripture references in this video. Click the arrow to expand and see references in context.</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-neutral-300 dark:divide-neutral-700">
                        <thead class="bg-neutral-200 dark:bg-neutral-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-700 dark:text-neutral-300 uppercase tracking-wider w-16"></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Book</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Confirmed</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Suspect</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">False Positives</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-neutral-100 dark:bg-neutral-800 divide-y divide-neutral-300 dark:divide-neutral-700">
                            {% set book_data = [] %}
                            {% for book in video.counts %}
                                {% set total = video.counts[book] + video.suspect_counts[book] %}
                                {% set fp_count = video.positions.get(book, {}).get('false_positive', [])|length if video.positions else 0 %}
                                {% if total > 0 %}
                                    {% set _ = book_data.append({'book': book, 'confirmed': video.counts[book], 'suspect': video.suspect_counts[book], 'false_positives': fp_count, 'total': total}) %}
                                {% endif %}
                            {% endfor %}
                            {% set sorted_books = book_data|sort(attribute='total', reverse=True) %}
                            
                            <tr class="bg-neutral-100 dark:bg-neutral-800">
                                <td></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-neutral-950 dark:text-white">Total</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-primary-400">{{ video.stats.scripture_references }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-primary-300">{{ video.stats.suspect_references }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-primary-400">{{ video.stats.false_positives }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-primary-400">{{ video.stats.total_matches }}</td>
                            </tr>
                            
                            {% for book_info in sorted_books %}
                            <tr class="book-row" data-book="{{ book_info.book }}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <button class="expand-btn text-primary-400 hover:text-primary-300 transition-colors">
                                        <svg class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-neutral-950 dark:text-white">{{ book_info.book }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-400">{{ book_info.confirmed }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-300">{{ book_info.suspect }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-400">{{ book_info.false_positives }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-400">{{ book_info.total }}</td>
                            </tr>
                            <tr class="references-row hidden" data-book="{{ book_info.book }}">
                                <td colspan="6" class="px-6 py-4">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-neutral-400 dark:divide-neutral-600">
                                            <thead class="bg-neutral-300 dark:bg-neutral-600">
                                                <tr>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">#</th>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Time</th>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Book</th>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Ch/V</th>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Context</th>
                                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Type</th>
                                                </tr>
                                            </thead>
                                            {% set book_refs = all_refs_by_book.get(book_info.book, []) %}
                                            <tbody class="bg-neutral-200 dark:bg-neutral-700 divide-y divide-neutral-400 dark:divide-neutral-600">
                                                {% for ref in book_refs %}
                                                <tr>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-neutral-700 dark:text-neutral-300">
                                                        {{ loop.index }}
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                                                        {% set total_seconds = ref.get('start', 0)|round|int %}
                                                        {% set hours = total_seconds // 3600 %}
                                                        {% set minutes = (total_seconds % 3600) // 60 %}
                                                        {% set seconds = total_seconds % 60 %}
                                                        {{ "%02d"|format(hours) }}:{{ "%02d"|format(minutes) }}:{{ "%02d"|format(seconds) }}
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-primary-400">
                                                        {% set chapter = '1' %}
                                                        {% if ref.get('verse') and ref.get('verse') != 'N/A' %}
                                                            {% if ':' in ref.get('verse') %}
                                                                {% set verse_parts = ref.get('verse').split(':') %}
                                                                {% set chapter = verse_parts[0] %}
                                                            {% else %}
                                                                {% set chapter = ref.get('verse') %}
                                                            {% endif %}
                                                        {% endif %}
                                                        <a href="https://read.lsbible.org/?q={{ book_info.book|replace(' ', '+') }}{{ '+' }}{{ chapter }}" target="_blank" class="hover:underline">
                                                            {{ book_info.book }}
                                                        </a>
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-neutral-700 dark:text-neutral-300">
                                                        {% if ref.get('verse') and ref.get('verse') != 'N/A' %}
                                                        <a href="https://read.lsbible.org/?q={{ book_info.book|replace(' ', '+') }}{{ '+' }}{{ ref.get('verse')|replace(':', '%3A') }}" target="_blank" class="text-primary-400 hover:underline">
                                                            {{ ref.get('verse') }}
                                                        </a>
                                                        {% else %}
                                                        <a href="https://read.lsbible.org/?q={{ book_info.book|replace(' ', '+') }}{{ '+' }}{{ chapter }}" target="_blank" class="text-primary-400 hover:underline">
                                                            {{ chapter }}
                                                        </a>
                                                        {% endif %}
                                                    </td>
                                                    <td class="px-4 py-4 text-sm text-neutral-700 dark:text-neutral-300 max-w-2xl whitespace-normal break-words">
                                                        "{{ ref.get('context_html', ref.get('context', 'No context available'))|safe }}"
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap">
                                                        {% if ref.get('type') == 'confirmed' %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                                                            Confirmed
                                                        </span>
                                                        {% elif ref.get('type') == 'suspect' %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                                                            Suspect
                                                        </span>
                                                        {% elif ref.get('type') == 'false_positive' %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-neutral-300 text-neutral-700 dark:bg-neutral-600 dark:text-neutral-200">
                                                            False Positive
                                                        </span>
                                                        {% else %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-neutral-300 text-neutral-700 dark:bg-neutral-600 dark:text-neutral-200">
                                                            Unknown
                                                        </span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                                {% if not book_refs %}
                                                <tr>
                                                    <td colspan="6" class="px-4 py-8 text-center text-sm text-gray-400">
                                                        Position data not available for this book. Please re-analyze the video to see detailed scripture references with timestamps and context.
                                                    </td>
                                                </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            html.classList.remove('dark');
        }

        // Chart
        const videoData = JSON.parse(document.getElementById('video-data').textContent);
        const ctx = document.getElementById('referencesChart').getContext('2d');
        const bookCounts = videoData.counts;
        const suspectBookCounts = videoData.suspect_counts;
        
        // Bible book order for sorting
        const BIBLE_BOOKS = [
            "Genesis", "Exodus", "Leviticus", "Numbers", "Deuteronomy",
            "Joshua", "Judges", "Ruth", "1 Samuel", "2 Samuel",
            "1 Kings", "2 Kings", "1 Chronicles", "2 Chronicles",
            "Ezra", "Nehemiah", "Esther", "Job", "Psalms", "Proverbs",
            "Ecclesiastes", "Song of Solomon", "Isaiah", "Jeremiah",
            "Lamentations", "Ezekiel", "Daniel", "Hosea", "Joel",
            "Amos", "Obadiah", "Jonah", "Micah", "Nahum", "Habakkuk",
            "Zephaniah", "Haggai", "Zechariah", "Malachi",
            "Matthew", "Mark", "Luke", "John", "Acts", "Romans",
            "1 Corinthians", "2 Corinthians", "Galatians", "Ephesians",
            "Philippians", "Colossians", "1 Thessalonians", "2 Thessalonians",
            "1 Timothy", "2 Timothy", "Titus", "Philemon", "Hebrews",
            "James", "1 Peter", "2 Peter", "1 John", "2 John", "3 John",
            "Jude", "Revelation"
        ];
        
        const bookData = [];
        Object.keys(bookCounts).forEach(book => {
            const total = bookCounts[book] + (suspectBookCounts[book] || 0);
            if (total > 0) {
                bookData.push({
                    book: book,
                    confirmed: bookCounts[book],
                    suspect: suspectBookCounts[book] || 0,
                    order: BIBLE_BOOKS.indexOf(book)
                });
            }
        });
        
        // Sort by biblical order
        bookData.sort((a, b) => a.order - b.order);
        
        const labels = bookData.map(item => item.book);
        const confirmedData = bookData.map(item => item.confirmed);
        const suspectData = bookData.map(item => item.suspect);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Confirmed References',
                    data: confirmedData,
                    backgroundColor: '#7dcf00',
                    borderColor: '#61a500',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            color: '#a1a1a1'
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grace: '10%',
                        ticks: {
                            color: '#a1a1a1'
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#9ca3af'
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#9ca3af',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

        // Book expansion functionality
        let currentlyOpenBook = null;

        document.querySelectorAll('.expand-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const row = this.closest('.book-row');
                const book = row.dataset.book;
                const referencesRow = document.querySelector(`.references-row[data-book="${book}"]`);
                const arrow = this.querySelector('svg');

                // Close currently open book if different
                if (currentlyOpenBook && currentlyOpenBook !== book) {
                    const currentRow = document.querySelector(`.references-row[data-book="${currentlyOpenBook}"]`);
                    const currentArrow = document.querySelector(`.book-row[data-book="${currentlyOpenBook}"] .expand-btn svg`);
                    if (currentRow) {
                        currentRow.classList.add('hidden');
                        currentArrow.classList.remove('rotate-90');
                    }
                }

                // Toggle current book
                if (referencesRow.classList.contains('hidden')) {
                    referencesRow.classList.remove('hidden');
                    arrow.classList.add('rotate-90');
                    currentlyOpenBook = book;
                } else {
                    referencesRow.classList.add('hidden');
                    arrow.classList.remove('rotate-90');
                    currentlyOpenBook = null;
                }
            });
        });

        // Timeline functionality - populate automatically on page load
        const timelineContent = document.getElementById('timeline-content');

        // Function to populate timeline
        function populateTimeline() {
            // Get refs data
            const allRefsByBook = JSON.parse(document.getElementById('refs-data').textContent);

            // Collect all references
            const allRefs = [];
            Object.keys(allRefsByBook).forEach(book => {
                allRefsByBook[book].forEach(ref => {
                    allRefs.push({
                        ...ref,
                        book: book
                    });
                });
            });

            // Sort by start time
            allRefs.sort((a, b) => a.start - b.start);

            // Generate timeline HTML
            let timelineHtml = '';
            if (allRefs.length === 0) {
                timelineHtml = '<p class="text-center text-gray-500 py-8">No scripture references found in this video.</p>';
            } else {
                allRefs.forEach((ref, index) => {
                    const totalSeconds = Math.round(ref.start);
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;
                    const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                    const typeClass = ref.type === 'confirmed' ? 'bg-primary-100 text-primary-800' :
                                    ref.type === 'suspect' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-gray-100 text-gray-800';

                    timelineHtml += `
                        <div class="flex items-start space-x-4 p-4 bg-neutral-50 dark:bg-neutral-700 rounded-lg">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                    ${index + 1}
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-sm font-medium text-primary-400">${timeStr}</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeClass}">
                                        ${ref.type === 'confirmed' ? 'Confirmed' : ref.type === 'suspect' ? 'Suspect' : 'False Positive'}
                                    </span>
                                </div>
                                <div class="text-sm text-neutral-700 dark:text-neutral-300 mb-1">
                                    <strong>${ref.book}</strong> ${ref.verse || 'N/A'}
                                </div>
                                <div class="text-sm text-neutral-600 dark:text-neutral-400">
                                    "${ref.context || 'No context available'}"
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            timelineContent.innerHTML = timelineHtml;
        }

        // Populate timeline on page load
        populateTimeline();
    </script>

    <!-- Version Display -->
    <div class="bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto py-2 px-4 sm:px-6 lg:px-8">
            <div class="text-center text-xs text-gray-500 dark:text-gray-400">
                MannaMeter v{{ version }}
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 dark:bg-gray-800 mt-12">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <div class="text-center text-sm text-gray-600 dark:text-gray-400">
                <p>© 2025 MannaMeter™ by B3boBytes. All rights reserved.</p>
                <p class="mt-2">Disclaimer: This tool is for educational and analytical purposes only. It does not guarantee accuracy of scripture references or endorse any content.</p>
            </div>
        </div>
    </footer>
</body>
</html>