/**
 * @file filters/index.js
 * @description Filter coordination, state management, and apply logic.
 * @copyright 2025 Kimberly Bauman, P.A. All rights reserved.
 */
import{eventBus as e,Events as t}from"../core/eventBus.js";export function initFilterState(){window.filterState=window.filterState||{propertyType:null,areas:new Set,amenities:new Set,priceMin:0,priceMax:41,bedsMin:1,bathsMin:1}}export function formatSliderPrice(e){return e>=1e6?"$"+(e/1e6).toFixed(e%1e6==0?0:1)+"M":"$"+(e/1e3).toFixed(0)+"K"}export function updatePriceSlider(e,t,i){if(!e||!t)return;const n=window.PRICE_STEPS||[],a=document.getElementById("price-display"),o=document.getElementById("price-fill");let d=parseInt(e.value)||0,l=parseInt(t.value)||41;if(d>l&&(i?.target===t?(e.value=l,d=l):(t.value=d,l=d)),window.filterState.priceMin=d,window.filterState.priceMax=l,a)if(0===d&&0===l)a.textContent="$250K - $35M+";else{const e=n[d]||n[0],t=n[l]||n[n.length-1];a.textContent=`${formatSliderPrice(e)} - ${formatSliderPrice(t)}${41===l?"+":""}`}if(o){const e=d/41,t=l/41;0===d?(o.style.left="0",o.style.width=100*t+"%"):(o.style.left=100*e+"%",o.style.width=100*(t-e)+"%")}applyFilters()}export function updateBedsSlider(){const e=document.getElementById("beds-min"),t=document.getElementById("beds-display"),i=document.getElementById("beds-fill");if(!e)return;const n=parseInt(e.value)||1;if(window.filterState.bedsMin=n,t&&(t.textContent=n>=6?"6+":`${n}+`),i){const e=(n-1)/5*100;i.style.width=`${e}%`}applyFilters()}export function updateBathsSlider(){const e=document.getElementById("baths-min"),t=document.getElementById("baths-display"),i=document.getElementById("baths-fill");if(!e)return;const n=parseInt(e.value)||1;if(window.filterState.bathsMin=n,t&&(t.textContent=n>=6?"6+":`${n}+`),i){const e=(n-1)/5*100;i.style.width=`${e}%`}applyFilters()}export function applyFilters(){const i=window.PRICE_STEPS||[],n=document.getElementById("btn-homes"),a=document.getElementById("btn-condos"),o=!!n&&n.classList.contains("active"),d=!!a&&a.classList.contains("active"),l=window.filterState.areas,r=window.filterState.amenities,s=window.filterState.priceMin||0,c=window.filterState.priceMax||41,w=window.filterState.bedsMin||1,m=window.filterState.bathsMin||1;let u=0===s?0:i[s]||0,p=c>=41?Number.MAX_SAFE_INTEGER:i[c]||Number.MAX_SAFE_INTEGER;window.filteredNeighborhoods=(window.neighborhoods||[]).filter(e=>{let t=!0;if(o||d){t=!1;const i=(e.propertyType||"").toLowerCase();!o||"homes"!==i&&"townhomes"!==i||(t=!0),d&&"condos"===i&&(t=!0)}let i=!0;l.size>0&&(i=l.has(e.zipCode)||l.has(e.area)||l.has(e.subArea));let n=!0;r.size>0&&(n=[...r].every(t=>e.amenities&&e.amenities.includes(t)));let a=!0;const s=e.stats||{},c=void 0!==s.minPrice?parseFloat(s.minPrice):null,y=void 0!==s.maxPrice?parseFloat(s.maxPrice):null;null===c||null===y||isNaN(c)||isNaN(y)?s.avgPrice>0&&(a=s.avgPrice>=u&&s.avgPrice<=p):a=p>=c&&u<=y;let f=!0;if(w>1){const e=void 0!==s.maxBeds?parseFloat(s.maxBeds):null;null===e||isNaN(e)||(f=e>=w)}let h=!0;if(m>1){const e=void 0!==s.maxBaths?parseFloat(s.maxBaths):null;null===e||isNaN(e)||(h=e>=m)}return t&&i&&n&&a&&f&&h}),window.renderResults&&window.renderResults(),window.addMarkers&&window.addMarkers(),window.fitBoundsToNeighborhoods&&window.fitBoundsToNeighborhoods(),e.emit(t.FILTERS_APPLIED,{count:window.filteredNeighborhoods.length,filters:{propertyType:o?"homes":d?"condos":null,areas:[...l],amenities:[...r],priceMin:u,priceMax:p,bedsMin:w,bathsMin:m}})}export function clearAllFilters(){window.filterState={propertyType:null,areas:new Set,amenities:new Set,priceMin:0,priceMax:41,bedsMin:1,bathsMin:1},window.searchQuery="";const i=document.getElementById("search-input");i&&(i.value="");const n=document.getElementById("price-min"),a=document.getElementById("price-max");n&&(n.value=0),a&&(a.value=41);const o=document.getElementById("beds-min"),d=document.getElementById("baths-min");o&&(o.value=1),d&&(d.value=1);const l=document.getElementById("btn-homes"),r=document.getElementById("btn-condos");l&&l.classList.remove("active"),r&&r.classList.remove("active"),document.querySelectorAll("[data-filter-type]").forEach(e=>{e.classList.remove("bg-brand-600","text-white"),e.classList.add("bg-white","text-neutral-700")}),document.querySelectorAll(".area-tag").forEach(e=>{e.classList.remove("selected")}),window.areaMarkers&&window.areaMarkers.forEach((e,t)=>{window.hideAreaMarker&&window.hideAreaMarker(t)}),document.querySelectorAll("input[data-amenity]").forEach(e=>{e.checked=!1}),document.querySelectorAll(".amenity-tag").forEach(e=>{e.classList.remove("selected")}),window.customBoundaries&&window.hideCustomBoundary&&[...window.customBoundaries].forEach(e=>{window.hideCustomBoundary(e)}),window.filteredNeighborhoods=[...window.neighborhoods||[]],window.renderResults&&window.renderResults(),window.addMarkers&&window.addMarkers();const s=document.getElementById("price-display");s&&(s.textContent="$250K - $35M+");const c=document.getElementById("beds-display"),w=document.getElementById("baths-display");c&&(c.textContent="1+"),w&&(w.textContent="1+");const m=document.getElementById("price-fill"),u=document.getElementById("beds-fill"),p=document.getElementById("baths-fill");m&&(m.style.left="0",m.style.width="100%"),u&&(u.style.width="0%"),p&&(p.style.width="0%"),"undefined"!=typeof gtag&&gtag("event","clear_filters"),e.emit(t.FILTERS_CLEARED)}export function handleAreaTagClick(e){e.classList.toggle("selected");const t=e.getAttribute("data-zipcode"),i=e.getAttribute("data-subarea"),n=e.classList.contains("selected");t&&(n?(window.filterState.areas.add(t),window.showCustomBoundary&&window.showCustomBoundary(t)):(window.filterState.areas.delete(t),window.hideCustomBoundary&&window.hideCustomBoundary(t)),"undefined"!=typeof gtag&&gtag("event","filter_area",{area:t,action:n?"selected":"deselected"})),i&&(n?window.filterState.areas.add(i):window.filterState.areas.delete(i),"undefined"!=typeof gtag&&gtag("event","filter_subarea",{subarea:i,action:n?"selected":"deselected"})),applyFilters()}export function handleAmenityTagClick(e){const t=e.getAttribute("data-amenity");if(!t)return;if("Short-Term Allowed"===t){const e=document.querySelector('.amenity-tag[data-amenity="No Short-Term"]');e&&e.classList.contains("selected")&&(e.classList.remove("selected"),window.filterState.amenities.delete("No Short-Term"))}else if("No Short-Term"===t){const e=document.querySelector('.amenity-tag[data-amenity="Short-Term Allowed"]');e&&e.classList.contains("selected")&&(e.classList.remove("selected"),window.filterState.amenities.delete("Short-Term Allowed"))}e.classList.toggle("selected");const i=e.classList.contains("selected");i?window.filterState.amenities.add(t):window.filterState.amenities.delete(t),"undefined"!=typeof gtag&&gtag("event","filter_amenity",{amenity:t,action:i?"selected":"deselected"}),applyFilters()}export function handlePropertyTypeClick(e){e.classList.toggle("active"),applyFilters()}"undefined"!=typeof window&&(window.applyFilters=applyFilters,window.clearAllFilters=clearAllFilters,window.updateBedsSlider=updateBedsSlider,window.updateBathsSlider=updateBathsSlider,window.handleAreaTagClick=handleAreaTagClick,window.handleAmenityTagClick=handleAmenityTagClick,window.handlePropertyTypeClick=handlePropertyTypeClick,window.formatSliderPrice=formatSliderPrice,window.initFilterState=initFilterState,initFilterState());