/**
 * @file app.js
 * @description Main application entry point and orchestration.
 * @copyright 2025 Kimberly Bauman, P.A. All rights reserved.
 * @author John Bauman
 */
import{CONFIG as e}from"./config.js";import{STATE as o}from"./state.js";import{getUrlParams as t,toSlug as r}from"./utils.js?v=202501";import{initializeMap as n,computeOffsetPx as a,offsetLatLng as s,fitBoundsToNeighborhoods as i,smoothFlyTo as d}from"./map.js?v=202501";import{loadNeighborhoods as l}from"./data.js";import{setupUI as c,navigateNeighborhood as m}from"./ui.js";import{showInfoWindow as g,createMarkerIcon as p}from"./markers.js";import{setupFilters as u,applyFilters as h}from"./filters.js";async function y(){try{if(document.documentElement.style.setProperty("--panel-duration",e.animations.panelSlideDuration+"ms"),"undefined"==typeof google||!google.maps)return console.error("Google Maps API not loaded"),void(document.getElementById("loading-screen").innerHTML='<div class="text-center"><p class="text-red-600 font-medium">Error loading map. Please refresh the page.</p></div>');o.neighborhoods=await l();const m=t();if(m.neighborhood){const e=o.neighborhoods.filter(e=>r(e.name)===m.neighborhood);let t;if(e.length>0){if(m.propertyType){const o=m.propertyType.toLowerCase();t=e.find(e=>{if(!e.propertyType)return!1;const t=e.propertyType.toLowerCase();return"homes"===o||"home"===o?"homes"===t||"home"===t:"townhomes"===o||"townhome"===o?t.includes("townhome"):"condos"===o||"condo"===o?t.includes("condo"):"lots"===o||"lot"===o?t.includes("lot")||t.includes("land")||t.includes("vacant"):t.includes(o)})||e[0]}else t=e.find(e=>e.propertyType&&("homes"===e.propertyType.toLowerCase()||"home"===e.propertyType.toLowerCase()))||e[0];o.neighborhoods=[t]}}const y=window.self!==window.top;if("single"===m.mode){const e=document.getElementById("sidebar"),o=document.getElementById("drawer-toggle"),t=document.querySelector(".bg-neutral-800");e&&e.style.setProperty("display","none","important"),o&&(o.style.display="none"),t&&(t.style.display="none"),document.querySelector('label[for="drawer-toggle"]')?.remove()}if(y){const e=document.getElementById("map-disclaimer");e&&(e.style.display="none")}let f,k;if(m.lat&&m.lng?(f={lat:m.lat,lng:m.lng},k=m.zoom||14):m.neighborhood&&1===o.neighborhoods.length?(f=o.neighborhoods[0].position,k=m.zoom||("single"===m.mode?e.map.singleNeighborhoodZoom:14)):(f=e.map.defaultCenter,k=m.zoom||e.map.defaultZoom),n(f,k),!m.mode&&!m.lat&&!m.lng&&o.neighborhoods.length>1&&google.maps.event.addListenerOnce(o.map,"idle",()=>{i(o.neighborhoods,80)}),"single"===m.mode&&1===o.neighborhoods.length){google.maps.event.addListenerOnce(o.map,"projection_changed",()=>{m.zoom||o.map.setZoom(13);const e=o.map.getZoom(),t=a(e),r=s(f,t,e);o.map.setCenter(r)});const e=()=>{if(o.markers.length>0){const e=o.markers[0],t=e.marker,r=e.neighborhood;return t.setIcon(p(t.markerColor,!0)),o.activeMarker=t,g(t,r),console.log("Single mode: opened info window for",r.name),!0}return!1};let t=0;const r=()=>{t++,e()||(t<30?setTimeout(r,100):console.log("Single mode: marker not found after 3 seconds"))};setTimeout(r,200)}const b=document.getElementById("loading-screen");if(b&&(b.style.display="none"),m.autoOpen&&1===o.neighborhoods.length&&"single"!==m.mode){let e=0;const t=()=>{e++,o.markers.length>0?(google.maps.event.trigger(o.markers[0].marker,"click"),console.log("autoOpen: triggered marker click")):e<30&&setTimeout(t,100)};setTimeout(t,200)}if(m.marker){console.log("Marker parameter detected:",m.marker);const t=()=>{const t=m.marker.toLowerCase(),n=m.propertyType;console.log("Auto-opening marker:",t,"propertyType:",n),console.log("Total markers available:",o.markers.length);const a=o.markers.find(e=>{const o=r(e.neighborhood.name)===t;return n?o&&e.neighborhood.propertyType?.toLowerCase()===n.toLowerCase():o});if(a){console.log("Found target marker, triggering click:",a.neighborhood.name);const o=a.neighborhood.zipCode;if(o){const e=document.querySelector(`#areaFilters .amenity-tag[data-zipcode="${o}"]`);e&&!e.classList.contains("selected")&&e.classList.add("selected")}const t=a.neighborhood.position;return d(t,13),setTimeout(()=>{google.maps.event.trigger(a.marker,"click")},e.map.flyToDuration+500),!0}return console.log("Target marker not found yet, will retry..."),!1};let n=0;const a=25,s=()=>{n++,console.log(`Marker poll attempt ${n}/${a}, markers: ${o.markers.length}`),o.markers.length>0&&t()||(n<a?setTimeout(s,200):console.log("Max attempts reached, marker not found"))};setTimeout(s,500)}c(),u(),h();const v=["bg-brand-500","text-white","border-brand-500","hover:bg-brand-600","active:bg-brand-700","dark:bg-brand-dark","dark:text-white","dark:border-brand-dark","dark:hover:bg-brand-dark-hover"],w=["bg-white","text-neutral-700","border-neutral-300","hover:bg-brand-100","hover:text-brand-700","active:bg-brand-200","dark:bg-dark-bg-elevated-2","dark:text-dark-text-primary","dark:border-dark-border","dark:hover:bg-brand-dark/20","dark:hover:text-brand-dark","dark:active:bg-brand-dark/30"],T=(e,o)=>{o?(e.classList.remove(...w),e.classList.add(...v)):(e.classList.remove(...v),e.classList.add(...w))};document.querySelectorAll(".property-type-btn").forEach(e=>{e.addEventListener("click",function(){const e=!this.classList.contains("active");this.classList.toggle("active",e),T(this,e),h()})})}catch(e){console.error("Error initializing map:",e);const o=document.getElementById("loading-screen");if(o)o.innerHTML='<div class="text-center"><p class="text-red-600 font-medium">Error loading map. Please refresh the page.</p></div>';else{const e=document.getElementById("map");e&&(e.innerHTML='<div class="flex items-center justify-center h-full"><p class="text-red-600 font-medium">Error loading map. Please refresh the page.</p></div>')}}}window.navigateNeighborhood=m,document.addEventListener("keydown",e=>{o.infoWindow&&o.infoWindow.getMap()&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&("ArrowLeft"===e.key?(e.preventDefault(),m(-1)):"ArrowRight"===e.key&&(e.preventDefault(),m(1)))}),document.addEventListener("click",e=>{o.infoWindow&&o.infoWindow.getMap()&&e.target.closest(".info-window")&&("A"===e.target.tagName||e.target.closest("a")||e.target.closest("button")||e.target.closest(".nav-arrow")||(o.infoWindow.close(),o.activeMarker&&o.activeMarker.setIcon(p(o.activeMarker.markerColor,!1)),o.activeMarker=null))}),window.initMap=y,window.appInitMap=y,window.googleMapsReady&&y(),setTimeout(()=>{const e=document.getElementById("loading-screen");if(e&&"none"!==e.style.display&&!o.map){if(console.warn("Map load timeout triggered."),"undefined"!=typeof google&&google.maps)return void y().catch(e=>console.error("Manual initMap failed:",e));console.error("Map load timeout - initMap was not called or failed to complete"),e.innerHTML=`\n                <div class="text-center px-4">\n                    <p class="text-red-600 font-medium mb-2">Map failed to load.</p>\n                    <p class="text-sm text-neutral-500">This may be due to a network issue or configuration error.</p>\n                    <p class="text-xs text-neutral-400 mt-2">Status: ${"undefined"!=typeof google?"API Loaded":"API Missing"}</p>\n                    <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-neutral-800 text-white rounded-lg text-sm">Refresh Page</button>\n                </div>\n            `}},5e3),window.location.search.includes("debug=true")||(document.addEventListener("keydown",function(e){("F12"===e.key||e.ctrlKey&&e.shiftKey&&("I"===e.key||"J"===e.key||"C"===e.key)||e.ctrlKey&&"U"===e.key||e.ctrlKey&&("s"===e.key||"S"===e.key)||e.ctrlKey&&("p"===e.key||"P"===e.key))&&e.preventDefault()}),document.addEventListener("contextmenu",function(e){e.preventDefault()}));