/**
 * @file map.js
 * @description Core map initialization and camera movement logic.
 * @copyright 2025 Kimberly Bauman, P.A. All rights reserved.
 * @author John Bauman
 */
import{CONFIG as e}from"./config.js";import{STATE as t}from"./state.js";import{getUrlParams as o,clamp as n,getThemeColor as r,toSlug as l}from"./utils.js";import{addMarkers as s,showInfoWindow as a}from"./markers.js";import{setupFilters as i,applyFilters as c}from"./filters.js";import{loadNeighborhoods as m}from"./data.js";export function initializeMap(n,r){const a=document.documentElement.classList.contains("dark")?"dark":"light";t.map=new google.maps.Map(document.getElementById("map"),{zoom:r,center:n,mapId:e.map.mapId,colorScheme:"dark"===a?"DARK":"LIGHT",mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.TOP_RIGHT},streetViewControl:!0,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},fullscreenControl:!0,fullscreenControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT},zoomControl:!0,clickableIcons:!1});let i=t.map.getZoom();t.map.addListener("idle",()=>{const e=t.map.getZoom();e!==i&&(i=e)}),t.infoWindow=new google.maps.InfoWindow({maxWidth:280,disableAutoPan:!0}),t.hoverInfoWindow=new google.maps.InfoWindow({maxWidth:280,disableAutoPan:!0}),google.maps.event.addListener(t.hoverInfoWindow,"domready",()=>{const e=document.querySelector(".gm-style-iw-c");e&&t.hoverInfoWindow.getMap()&&(e.parentElement.style.zIndex="100")}),window.addEventListener("themechange",o=>{!function(o){if(!t.map)return void console.log("applyMapTheme called but map not initialized yet");console.log("Applying map theme:",o);const n=t.map.getCenter(),r=t.map.getZoom(),l=t.markers,s=t.infoWindow,a=t.hoverInfoWindow;t.map=null,t.map=new google.maps.Map(document.getElementById("map"),{zoom:r,center:n,mapId:e.map.mapId,colorScheme:"dark"===o?"DARK":"LIGHT",mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.TOP_RIGHT},streetViewControl:!0,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},fullscreenControl:!0,fullscreenControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT},zoomControl:!0,clickableIcons:!1}),t.infoWindow=s,t.hoverInfoWindow=a,l.forEach(e=>{e.marker&&e.marker.setMap(t.map)}),console.log("Map recreated with colorScheme:","dark"===o?"DARK":"LIGHT")}(o.detail.theme)}),setTimeout(()=>{document.querySelectorAll('button[title*="fullscreen" i], button[aria-label*="fullscreen" i]').forEach(e=>{e.addEventListener("click",e=>{if(e.preventDefault(),e.stopPropagation(),document.fullscreenElement)document.exitFullscreen();else{document.body.requestFullscreen();const e=document.getElementById("drawer-toggle");e&&"single"!==h.mode&&setTimeout(()=>{e.checked=!0},100)}},!0)})},1e3),document.addEventListener("fullscreenchange",()=>{const e=document.getElementById("drawer-toggle");document.fullscreenElement&&"single"!==h.mode&&e&&(e.checked=!0)});const c=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),m=/iPhone|iPad|iPod/i.test(navigator.userAgent),u=document.getElementById("map-layout"),d='\n        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>\n        </svg>\n    ',p=e=>{try{window.parent.postMessage({type:"fullscreenChanged",active:e},"*")}catch(e){console.warn("postMessage to host failed",e)}};let g=null;if(c&&u){const e=document.createElement("button");e.className="mobile-fullscreen-btn absolute top-2.5 right-2.5 z-10 bg-white dark:bg-dark-bg-elevated border border-transparent rounded w-10 h-10 cursor-pointer flex items-center justify-center text-neutral-700 dark:text-dark-text-primary hover:bg-neutral-100 dark:hover:bg-dark-bg-elevated-2 transition-colors",e.style.cssText="box-shadow: rgba(0, 0, 0, 0.3) 0px 1px 4px -1px;",e.title=m?"Open full version":"Toggle fullscreen",e.setAttribute("aria-pressed","false"),e.innerHTML=m?'\n        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n            <path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />\n        </svg>\n    ':d;const t=t=>{t?(e.classList.remove("absolute","z-10"),e.classList.add("fixed","z-[1100]"),e.style.opacity="0.95"):(e.classList.remove("fixed","z-[1100]"),e.classList.add("absolute","z-10"),e.style.opacity="1")};t(!1);const o=o=>{e.innerHTML=o?'\n        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n            <path d="M6 18 18 6M6 6l12 12" />\n        </svg>\n    ':d,e.setAttribute("aria-pressed",o?"true":"false"),t(o)},n=e=>{document.body.classList.toggle("mobile-faux-fullscreen",e),o(e),e&&window.scrollTo({top:0,behavior:"smooth"});const t=document.getElementById("drawer-toggle");t&&(t.checked=!e&&t.checked),p(e)};e.addEventListener("click",async e=>{if(e.stopPropagation(),e.preventDefault(),m){let e="https://neighborhoods.truesouthcoastalhomes.com";if(window.currentNeighborhood){const t=l(window.currentNeighborhood.name),o=window.currentNeighborhood.propertyType;e+=`?marker=${t}`,o&&(e+=`&propertyType=${encodeURIComponent(o)}`)}return void window.open(e,"_blank")}try{document.fullscreenElement?document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen&&await document.webkitExitFullscreen():u.requestFullscreen?await u.requestFullscreen():u.webkitRequestFullscreen&&await u.webkitRequestFullscreen()}catch(e){console.error("Fullscreen error:",e)}},!0),document.addEventListener("fullscreenchange",()=>{if(m)document.body.classList.contains("mobile-faux-fullscreen")||(o(!1),p(!1));else{const e=Boolean(document.fullscreenElement);o(e),p(e)}}),g=async e=>{if(void 0===e&&(e=!document.body.classList.contains("mobile-faux-fullscreen")&&!document.fullscreenElement),m)n(e);else try{e&&!document.fullscreenElement?u.requestFullscreen?await u.requestFullscreen():u.webkitRequestFullscreen&&await u.webkitRequestFullscreen():!e&&document.fullscreenElement&&(document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen&&await document.webkitExitFullscreen())}catch(e){console.error("Fullscreen error:",e)}},document.body.appendChild(e)}!g&&u&&(g=async e=>{const t="boolean"==typeof e?e:!document.fullscreenElement;try{t&&!document.fullscreenElement?u.requestFullscreen?await u.requestFullscreen():u.webkitRequestFullscreen&&await u.webkitRequestFullscreen():!t&&document.fullscreenElement&&(document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen&&await document.webkitExitFullscreen())}catch(e){console.error("Fullscreen error:",e)}});const f=["https://www.truesouthcoastalhomes.com","https://truesouthcoastalhomes.com","https://neighborhoods.truesouthcoastalhomes.com"];window.addEventListener("message",e=>{e.data&&f.includes(e.origin)&&g&&("enterFullscreen"===e.data.type?g(!0):"exitFullscreen"===e.data.type&&g(!1))}),s();const h=o();h.mode}export function showCustomBoundary(o){t.customBoundaries.has(o)||(t.customBoundaries.add(o),t.map.data.loadGeoJson(`${e.data.geojsonPath}${o}.geojson`,{idPropertyName:"ZCTA5CE20"},function(e){t.map.data.setStyle(function(e){const o=e.getProperty("ZCTA5CE20")||e.getProperty("ZCTA5CE10");if(t.customBoundaries.has(o)){const e=r("--color-primary");return{strokeColor:e,strokeWeight:1.5,strokeOpacity:.35,fillColor:e,fillOpacity:.15,clickable:!1}}return{visible:!1}})}))}export function hideCustomBoundary(e){t.customBoundaries.has(e)&&(t.customBoundaries.delete(e),t.map.data.forEach(function(o){(o.getProperty("ZCTA5CE20")||o.getProperty("ZCTA5CE10"))===e&&t.map.data.remove(o)}))}export function smoothFlyTo(o,n=15){const r=t.map,l=r.getCenter(),s=r.getZoom(),a=new google.maps.LatLng(o),i=offsetLatLng(o,calculateCenteredOffset(n),n);if(google.maps.geometry.spherical.computeDistanceBetween(l,a)<2e3){r.panTo(i);const e=n-s;if(Math.abs(e)>.1){let t=20,o=0;const n=setInterval(()=>{o++;const l=o/t,a=s+e*(1-(1-l)*(1-l));r.moveCamera({zoom:a}),o>=t&&clearInterval(n)},16)}return}const c=performance.now(),m=e.map.flyToDuration;requestAnimationFrame(function e(t){const o=t-c,a=Math.min(o/m,1),u=a<.5?4*a*a*a:1-Math.pow(-2*a+2,3)/2,d=l.lat()+(i.lat-l.lat())*u,p=l.lng()+(i.lng-l.lng())*u;let g;if(a<.5){const e=2*a,t=1-Math.pow(1-e,2);g=s+(11-s)*t}else{const e=2*(a-.5);g=11+e*e*(n-11)}r.moveCamera({center:{lat:d,lng:p},zoom:g}),a<1&&requestAnimationFrame(e)})}export function calculateCenteredOffset(e){const t=o();if(null!=t.offsetPx&&!isNaN(t.offsetPx))return t.offsetPx;if(null!=t.offsetPct&&!isNaN(t.offsetPct)){const e=Math.max(320,window.innerHeight);return n(e*t.offsetPct/100,100,300)}const r=window.innerWidth;let l;l=r<640?320:r<1024?300:280;const s=l/2-20;return Math.round(s+15)}export function computeOffsetPx(e){return calculateCenteredOffset(e)}export function offsetLatLng(e,o,n){const r=Math.pow(2,n||t.map.getZoom()),l=t.map.getProjection().fromLatLngToPoint(new google.maps.LatLng(e)),s=new google.maps.Point(0,-o/r),a=new google.maps.Point(l.x,l.y+s.y);return{lat:t.map.getProjection().fromPointToLatLng(a).lat(),lng:e.lng}}export function fitBoundsToNeighborhoods(e,o=50){if(!e||0===e.length)return;const n=new google.maps.LatLngBounds;e.forEach(e=>{n.extend(new google.maps.LatLng(e.position.lat,e.position.lng))});const r=n.getNorthEast(),l=n.getSouthWest();console.log("Calculated bounds - NE:",r.lat(),r.lng(),"SW:",l.lat(),l.lng()),console.log("Current map center before fitBounds:",t.map.getCenter().lat(),t.map.getCenter().lng()),console.log("Current zoom before fitBounds:",t.map.getZoom()),t.map.fitBounds(n,o),console.log("fitBounds called")}