/**
 * @file map/centering.js
 * @description Map centering and offset calculations using Mercator projection.
 * @copyright 2025 Kimberly Bauman, P.A. All rights reserved.
 */
import{createAnimation as t,Easing as o}from"../utils.js";import{eventBus as e,Events as n}from"../core/eventBus.js";let i=null;export const TAIL_HEIGHT=78;export const MARKER_RADIUS=10;export const CARD_HEIGHT_ESTIMATES={MINI:150,FULL_MOBILE:450,FULL_TABLET:380,FULL_DESKTOP:295};export const AREA_MARKER_HEIGHT_DELTA=70;export function latToMercatorY(t){const o=t*Math.PI/180;return Math.log(Math.tan(Math.PI/4+o/2))}export function preCalculateOffsetLat(t,o,e){const n=Math.pow(2,e),i=latToMercatorY(t)+o/(256*n/(2*Math.PI));return 180*(2*Math.atan(Math.exp(i))-Math.PI/2)/Math.PI}export function computeOffsetPx(t,o=!1,e=!1){const n=document.getElementById("map"),i=n?.offsetWidth||window.innerWidth,r=n?.offsetHeight||window.innerHeight;let a;e?(a=CARD_HEIGHT_ESTIMATES.MINI,console.log("[computeOffsetPx] Using MINI card height estimate:",a)):(a=i<640?CARD_HEIGHT_ESTIMATES.FULL_MOBILE:i<1024?CARD_HEIGHT_ESTIMATES.FULL_TABLET:CARD_HEIGHT_ESTIMATES.FULL_DESKTOP,console.log("[computeOffsetPx] Using FULL card height estimate:",a,"(viewport:",i,"px)"));const l=o?a+70:a;if(r>=450&&l+78+10<r-40)return Math.round((l+78-10)/2);{const t=20+l+78+10;return Math.round(Math.max(0,t-r/2))}}export function calculateInitialOffset(t,o=!1){return computeOffsetPx(t,o)}export function calculateCenteredOffset(t,o=0,e=!1){const n=computeOffsetPx(t,!1,e);return Math.round(n+o/2)}export function offsetLatLng(t,o,e){const n=window.map;if(!n||!n.getProjection())return console.warn("offsetLatLng called before map projection ready"),t;const i=Math.pow(2,e||n.getZoom()),r=n.getProjection().fromLatLngToPoint(new google.maps.LatLng(t)),a=new google.maps.Point(0,-o/i),l=new google.maps.Point(r.x,r.y+a.y);return{lat:n.getProjection().fromPointToLatLng(l).lat(),lng:t.lng}}export function getOpenInfoWindowCardHeightPx(){const t=document.querySelector(".gm-style-iw-c");if(t)return t.getBoundingClientRect().height;const o=document.querySelector(".info-window");return o?o.getBoundingClientRect().height:0}export function applyCenteringFromRenderedCard(t,o={}){const{maxRetries:e=30,usePaddingMethod:n=!1,maxCorrection:i=30,onComplete:r=null,attempt:a=0}=o,l=window.map;if(!l||!t)return!1;const c=document.getElementById("map");if(!c)return!1;const g=document.querySelector(".gm-style-iw-c");if(!g)return a<e&&requestAnimationFrame(()=>applyCenteringFromRenderedCard(t,{...o,attempt:a+1})),!1;if(n){const o=document.querySelector(".gm-style-iw");if(!o)return!1;const e=c.getBoundingClientRect(),n=o.getBoundingClientRect(),a=e.height,g=n.top-e.top;let s;const d=10,m=l.getBounds();if(!m)return!1;const u=m.getNorthEast(),p=m.getSouthWest(),f="function"==typeof t.lat?t.lat():t.lat,h=u.lat()-p.lat();s=(u.lat()-f)/h*a+d;const w=g-(a-s);if(Math.abs(w)<3)return r&&r(),!1;const M=Math.max(-i,Math.min(i,-w/2)),C=preCalculateOffsetLat(f,M,l.getZoom()),T=l.getCenter(),E=T.lat()+(C-f);return l.setCenter({lat:E,lng:T.lng()}),console.log(`Centering micro-correction: ${Math.round(w)}px diff, applied ${Math.round(M)}px`),r&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{r()})}),!0}{const o=document.querySelector(".gm-style-iw"),e=o?o.getBoundingClientRect().height:g.getBoundingClientRect().height,n=c||l.getDiv(),i=n?.getBoundingClientRect?.().height||n?.offsetHeight||window.innerHeight,a=i>=450&&e+78+10<i-40?Math.round((e+78-10)/2):Math.round(Math.max(0,20+e+78+10-i/2)),s=l.getZoom(),d="function"==typeof t.lat?t.lat():t.lat,m="function"==typeof t.lng?t.lng():t.lng,u=preCalculateOffsetLat(d,a,s);return l.setCenter({lat:u,lng:m}),console.log("Centering: applied with actual card height, offset:",a,"px"),r&&r(),!0}}export function applyMicroCenteringCorrection(t,o=30){return applyCenteringFromRenderedCard(t,{usePaddingMethod:!0,maxCorrection:o})}export function logCenteringDiagnostics(t){const o=window.map;if(!o||!t)return void console.log("=== CENTERING DIAGNOSTICS: No map or marker ===");const e=document.getElementById("map");if(!e)return void console.log("=== CENTERING DIAGNOSTICS: No map div ===");const n=document.querySelector(".gm-style-iw");if(!n)return void console.log("=== CENTERING DIAGNOSTICS: No info window found ===");const i=e.getBoundingClientRect(),r=n.getBoundingClientRect(),a=i.height,l=r.top-i.top,c=r.height,g=l+c;let s,d;const m=window.activeMarker;if(m&&m.content){const t=m.content.getBoundingClientRect(),o=t.top+t.height/2-i.top;s=o,d=o+10,console.log(`(Using DOM position: marker element at ${Math.round(t.top-i.top)}px, center at ${Math.round(o)}px)`)}else{const e=o.getBounds();if(!e)return void console.log("=== CENTERING DIAGNOSTICS: No bounds ===");const n=e.getNorthEast(),i=e.getSouthWest(),r="function"==typeof t.lat?t.lat():t.lat,l=latToMercatorY(n.lat()),c=latToMercatorY(i.lat());s=(l-latToMercatorY(r))/(l-c)*a,d=s+10,console.log("(Using lat/lng calculation with Mercator projection)")}const u=l,p=a-d,f=u-p;if(console.log("=== CENTERING DIAGNOSTICS ==="),console.log(`Viewport height: ${Math.round(a)}px`),console.log(`Card top: ${Math.round(l)}px`),console.log(`Card height: ${Math.round(c)}px (bottom at ${Math.round(g)}px)`),console.log(`Marker Y: ${Math.round(s)}px (bottom at ${Math.round(d)}px)`),console.log("---"),console.log(`Space ABOVE card: ${Math.round(u)}px`),console.log(`Space BELOW marker: ${Math.round(p)}px`),console.log(`Difference: ${Math.round(f)}px (${f<0?"more space below":f>0?"more space above":"centered"})`),console.log("============================="),window.parent&&window.parent!==window){const t=Math.abs(Math.round(f)),o=t<=5?"good":t<=20?"warn":"bad",e=f<0?"more space below":f>0?"more space above":"centered";window.parent.postMessage({type:"centeringDiagnostic",difference:`Difference: ${Math.round(f)}px (${e})`,status:o},"*")}}export function smoothFlyTo(r,a,l=!1,c=!1){const g=window.map;if(!g)return void console.error("[smoothFlyTo] No map available");console.log("[smoothFlyTo] Starting flight to:",r,"zoom:",a),i&&(console.log("[smoothFlyTo] Canceling previous animation"),i.cancel(),i=null),void 0===a&&(a=g.getZoom());const s=window.CONFIG?.map||{},d=g.getCenter(),m=g.getZoom(),u=new google.maps.LatLng(r);console.log("[smoothFlyTo] Start:",{lat:d.lat(),lng:d.lng(),zoom:m}),console.log("[smoothFlyTo] Target:",{lat:r.lat,lng:r.lng,zoom:a}),console.log("[smoothFlyTo] Mode:",window.isSingleMode?"SINGLE":"FULL","skipOffset:",l,"isMiniCard:",c);const p=window.isSingleMode?0:40;let f,h;l?(f=r,h=0,console.log("[smoothFlyTo] Skipping offset, flying directly to target")):(h=calculateCenteredOffset(a,p,c),f=offsetLatLng(r,h,a),console.log("[smoothFlyTo] Offset calculation:",{disclaimerHeight:p,isMiniCard:c,offsetPixels:h,offsetTarget:{lat:f.lat.toFixed(6),lng:f.lng.toFixed(6)}}));const w=l?0:calculateCenteredOffset(m,p,c),M=l?{lat:d.lat(),lng:d.lng()}:offsetLatLng({lat:d.lat(),lng:d.lng()},-w,m),C=new google.maps.LatLng(M),T=google.maps.geometry.spherical.computeDistanceBetween(C,u),E=s.flightZoomArc||{},I=s.flightDuration||{};let L,x,y;L=T<1e3?I.micro||800:T<2e3?I.short||1200:I.medium||2e3,T<(E.micro?.maxDistance||2e3)?(x=E.micro?.minZoom||13,y="micro"):T<(E.short?.maxDistance||5e3)?(x=E.short?.minZoom||13,y="short"):T<(E.medium?.maxDistance||2e4)?(x=E.medium?.minZoom||12,y="med"):(x=E.long?.minZoom||10,y="long"),x=m>=a?Math.min(x,m-1,a-1):m,console.log(`Flight: ${y} | ${(T/1e3).toFixed(2)}km | minZoom=${x}`),e.emit(n.FLY_TO_STARTED,{targetPosition:r,targetZoom:a});const A=performance.now();i=t(t=>{const l=t-A,c=Math.min(l/L,1),s=o.easeInOutCubic(c),u=d.lat()+(f.lat-d.lat())*s,p=d.lng()+(f.lng-d.lng())*s;let h;if(c<.5){const t=2*c,o=1-Math.pow(1-t,2);h=m+(x-m)*o}else{const t=2*(c-.5);h=x+t*t*(a-x)}return g.moveCamera({center:{lat:u,lng:p},zoom:h}),!(c>=1&&(i=null,e.emit(n.FLY_TO_COMPLETED,{targetPosition:r,targetZoom:a}),1))})}export function cancelFlyAnimation(){i&&(i.cancel(),i=null,e.emit(n.ANIMATION_CANCELLED,{type:"flyTo"}))}"undefined"!=typeof window&&(window.TAIL_HEIGHT=78,window.MARKER_RADIUS=10,window.CARD_HEIGHT_ESTIMATES=CARD_HEIGHT_ESTIMATES,window.AREA_MARKER_HEIGHT_DELTA=70,window.smoothFlyTo=smoothFlyTo,window.computeOffsetPx=computeOffsetPx,window.calculateCenteredOffset=calculateCenteredOffset,window.offsetLatLng=offsetLatLng,window.preCalculateOffsetLat=preCalculateOffsetLat,window.latToMercatorY=latToMercatorY,window.getOpenInfoWindowCardHeightPx=getOpenInfoWindowCardHeightPx,window.applyCenteringFromRenderedCard=applyCenteringFromRenderedCard,window.applyMicroCenteringCorrection=applyMicroCenteringCorrection,window.logCenteringDiagnostics=logCenteringDiagnostics);