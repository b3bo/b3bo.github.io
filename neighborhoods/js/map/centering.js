/**
 * @file map/centering.js
 * @description Map centering and offset calculations using Mercator projection.
 * @copyright 2025 Kimberly Bauman, P.A. All rights reserved.
 */
import{createAnimation as t,Easing as o}from"../utils.js";import{eventBus as e,Events as n}from"../core/eventBus.js";let a=null;export function preCalculateOffsetLat(t,o,e){const n=Math.pow(2,e),a=t*Math.PI/180,i=Math.log(Math.tan(Math.PI/4+a/2))+o/(256*n/(2*Math.PI));return 180*(2*Math.atan(Math.exp(i))-Math.PI/2)/Math.PI}export function computeOffsetPx(t,o=!1){const e=document.getElementById("map"),n=e?.offsetWidth||window.innerWidth,a=e?.offsetHeight||window.innerHeight,i=n<640?450:n<1024?380:340,r=o?i+70:i;if(a>=450&&r+78+10<a-40)return Math.round((r+78-10)/2);{const t=20+r+78+10;return Math.round(Math.max(0,t-a/2))}}export function calculateInitialOffset(t,o=!1){return computeOffsetPx(t,o)}export function calculateCenteredOffset(t,o=0){const e=computeOffsetPx(t,!1);return Math.round(e+o/2)}export function offsetLatLng(t,o,e){const n=window.map;if(!n||!n.getProjection())return console.warn("offsetLatLng called before map projection ready"),t;const a=Math.pow(2,e||n.getZoom()),i=n.getProjection().fromLatLngToPoint(new google.maps.LatLng(t)),r=new google.maps.Point(0,-o/a),l=new google.maps.Point(i.x,i.y+r.y);return{lat:n.getProjection().fromPointToLatLng(l).lat(),lng:t.lng}}export function getOpenInfoWindowCardHeightPx(){const t=document.querySelector(".gm-style-iw-c");if(t)return t.getBoundingClientRect().height;const o=document.querySelector(".info-window");return o?o.getBoundingClientRect().height:0}export function applyMicroCenteringCorrection(t,o=30){const e=window.map;if(!e||!t)return!1;const n=document.getElementById("map");if(!n)return!1;const a=document.querySelector(".gm-style-iw");if(!a)return!1;const i=n.getBoundingClientRect(),r=a.getBoundingClientRect(),l=i.height,c=r.top-i.top;let g;const s=window.activeMarker;if(s&&s.content){const t=s.content.getBoundingClientRect();g=t.top+t.height/2-i.top+10}else{const o=e.getBounds();if(!o)return!1;const n=o.getNorthEast(),a=o.getSouthWest(),i=n.lat()-a.lat(),r="function"==typeof t.lat?t.lat():t.lat;g=(n.lat()-r)/i*l+10}const u=c-(l-g);if(Math.abs(u)<5)return!1;const f=Math.max(-o,Math.min(o,-u/2)),m=e.getZoom(),p=preCalculateOffsetLat("function"==typeof t.lat?t.lat():t.lat,f,m),d=e.getCenter(),h="function"==typeof t.lat?t.lat():t.lat,w=d.lat()+(p-h);return e.panTo({lat:w,lng:d.lng()}),console.log(`Centering micro-correction: ${Math.round(u)}px diff, applied ${Math.round(f)}px`),!0}export function logCenteringDiagnostics(t){const o=window.map;if(!o||!t)return void console.log("=== CENTERING DIAGNOSTICS: No map or marker ===");const e=document.getElementById("map");if(!e)return void console.log("=== CENTERING DIAGNOSTICS: No map div ===");const n=document.querySelector(".gm-style-iw");if(!n)return void console.log("=== CENTERING DIAGNOSTICS: No info window found ===");const a=e.getBoundingClientRect(),i=n.getBoundingClientRect(),r=a.height,l=i.top-a.top,c=i.height,g=l+c;let s,u;const f=window.activeMarker;if(f&&f.content){const t=f.content.getBoundingClientRect(),o=t.top+t.height/2-a.top;s=o,u=o+10,console.log(`(Using DOM position: marker element at ${Math.round(t.top-a.top)}px, center at ${Math.round(o)}px)`)}else{const e=o.getBounds();if(!e)return void console.log("=== CENTERING DIAGNOSTICS: No bounds ===");const n=e.getNorthEast(),a=e.getSouthWest(),i=n.lat()-a.lat(),l="function"==typeof t.lat?t.lat():t.lat;s=(n.lat()-l)/i*r,u=s+10,console.log("(Using lat/lng calculation - less accurate)")}const m=l,p=r-u,d=m-p;console.log("=== CENTERING DIAGNOSTICS ==="),console.log(`Viewport height: ${Math.round(r)}px`),console.log(`Card top: ${Math.round(l)}px`),console.log(`Card height: ${Math.round(c)}px (bottom at ${Math.round(g)}px)`),console.log(`Marker Y: ${Math.round(s)}px (bottom at ${Math.round(u)}px)`),console.log("---"),console.log(`Space ABOVE card: ${Math.round(m)}px`),console.log(`Space BELOW marker: ${Math.round(p)}px`),console.log(`Difference: ${Math.round(d)}px (${d<0?"more space below":d>0?"more space above":"centered"})`),console.log("=============================")}export function smoothFlyTo(i,r){const l=window.map;if(!l)return;a&&(a.cancel(),a=null);const c=window.CONFIG?.map||{};void 0===r&&(r=c.defaultZoom||14);const g=l.getCenter(),s=l.getZoom(),u=new google.maps.LatLng(i),f=calculateCenteredOffset(r,40),m=offsetLatLng(i,f,r),p=calculateCenteredOffset(s,40),d=offsetLatLng({lat:g.lat(),lng:g.lng()},-p,s),h=new google.maps.LatLng(d),w=google.maps.geometry.spherical.computeDistanceBetween(h,u),C=c.flightZoomArc||{},M=c.flightDuration||{};let x,L,O;x=w<1e3?M.micro||800:w<2e3?M.short||1200:M.medium||2e3,w<(C.micro?.maxDistance||2e3)?(L=C.micro?.minZoom||13,O="micro"):w<(C.short?.maxDistance||5e3)?(L=C.short?.minZoom||13,O="short"):w<(C.medium?.maxDistance||2e4)?(L=C.medium?.minZoom||12,O="med"):(L=C.long?.minZoom||10,O="long"),L=s>=r?Math.min(L,s-1,r-1):s,console.log(`Flight: ${O} | ${(w/1e3).toFixed(2)}km | minZoom=${L}`),e.emit(n.FLY_TO_STARTED,{targetPosition:i,targetZoom:r});const I=performance.now();a=t(t=>{const c=t-I,u=Math.min(c/x,1),f=o.easeInOutCubic(u),p=g.lat()+(m.lat-g.lat())*f,d=g.lng()+(m.lng-g.lng())*f;let h;if(u<.5){const t=2*u,o=1-Math.pow(1-t,2);h=s+(L-s)*o}else{const t=2*(u-.5);h=L+t*t*(r-L)}return l.moveCamera({center:{lat:p,lng:d},zoom:h}),!(u>=1&&(a=null,e.emit(n.FLY_TO_COMPLETED,{targetPosition:i,targetZoom:r}),1))})}export function cancelFlyAnimation(){a&&(a.cancel(),a=null,e.emit(n.ANIMATION_CANCELLED,{type:"flyTo"}))}"undefined"!=typeof window&&(window.smoothFlyTo=smoothFlyTo,window.computeOffsetPx=computeOffsetPx,window.calculateCenteredOffset=calculateCenteredOffset,window.offsetLatLng=offsetLatLng,window.preCalculateOffsetLat=preCalculateOffsetLat,window.getOpenInfoWindowCardHeightPx=getOpenInfoWindowCardHeightPx,window.applyMicroCenteringCorrection=applyMicroCenteringCorrection,window.logCenteringDiagnostics=logCenteringDiagnostics);