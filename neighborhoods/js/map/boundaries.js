/**
 * @file map/boundaries.js
 * @description Lazy loading and caching of GeoJSON zip code boundaries.
 * @copyright 2025 Kimberly Bauman, P.A. All rights reserved.
 */
import{CONFIG as e}from"../config.js";import{eventBus as t,Events as o}from"../core/eventBus.js";const n=new Map,a=new Set,r=new Map;let s=null;export async function loadBoundary(t){if(n.has(t))return n.get(t);if(r.has(t))return r.get(t);const o=(async()=>{try{const o=await async function(t){const o=await async function(){if(s)return s;try{const t=e.data.manifestFile||"/assets/mls/ecar/manifest.json",o=await fetch(t);if(!o.ok)throw new Error("Failed to load manifest");return s=await o.json(),s}catch(e){return console.warn("Manifest load failed:",e.message),null}}();return o&&o.boundaries&&o.boundaries[t]?`${e.data.geojsonPath||"./assets/mls/ecar/boundaries/"}${o.boundaries[t].split("/").pop()}`:`${e.data.geojsonPath||"./assets/mls/ecar/boundaries/"}${t}.geojson.b64`}(t),a=await fetch(o);if(!a.ok)throw new Error(`Failed to load boundary for ${t}`);let r;if(o.endsWith(".b64")){const e=await a.text(),t=atob(e);r=JSON.parse(t)}else r=await a.json();return n.set(t,r),r}catch(e){return console.warn(`Boundary load failed for ${t}:`,e.message),null}finally{r.delete(t)}})();return r.set(t,o),o}function i(){const e=document.documentElement.classList.contains("dark")?"#5ba3ab":"#4c8f96";return{strokeColor:e,strokeWeight:1.5,strokeOpacity:.35,fillColor:e,fillOpacity:.15,clickable:!1}}export async function showBoundary(e){const n=window.map;if(!n)return!1;if(a.has(e))return!0;a.add(e);const r=await loadBoundary(e);return r?(n.data.addGeoJson(r,{idPropertyName:"ZCTA5CE20"}),n.data.setStyle(e=>{const t=e.getProperty("ZCTA5CE20")||e.getProperty("ZCTA5CE10");return a.has(t)?i():{visible:!1}}),t.emit(o.BOUNDARY_SHOWN,{zipCode:e}),!0):(a.delete(e),!1)}export function hideBoundary(e){const n=window.map;n&&a.has(e)&&(a.delete(e),n.data.forEach(t=>{(t.getProperty("ZCTA5CE20")||t.getProperty("ZCTA5CE10"))===e&&n.data.remove(t)}),t.emit(o.BOUNDARY_HIDDEN,{zipCode:e}))}export function hideAllBoundaries(){[...a].forEach(hideBoundary)}export function getVisibleBoundaries(){return new Set(a)}export function isBoundaryVisible(e){return a.has(e)}export function refreshBoundaryStyles(){const e=window.map;e&&e.data.setStyle(e=>{const t=e.getProperty("ZCTA5CE20")||e.getProperty("ZCTA5CE10");return a.has(t)?i():{visible:!1}})}export function preloadBoundaries(e){e.forEach(loadBoundary)}export function clearBoundaryCache(){n.clear()}"undefined"!=typeof window&&(window.customBoundaries=a,window.showCustomBoundary=showBoundary,window.hideCustomBoundary=hideBoundary,window.refreshBoundaryStyles=refreshBoundaryStyles,window.hideAllBoundaries=hideAllBoundaries);