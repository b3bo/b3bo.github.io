/**
 * @file filters.js
 * @description Logic for filtering neighborhoods by price, amenities, etc.
 * @copyright 2025 Kimberly Bauman, P.A. All rights reserved.
 * @author John Bauman
 */
import{CONFIG as e}from"./config.js";import{STATE as t}from"./state.js";import{formatSliderPrice as s,parseRange as n,updateUrlParams as a}from"./utils.js";import{createMarkers as r}from"./markers.js";import{renderListItems as i}from"./ui.js";import{showCustomBoundary as o,hideCustomBoundary as l,fitBoundsToNeighborhoods as c}from"./map.js?v=202501";const d=function(e){let t;return function(...s){clearTimeout(t),t=setTimeout(()=>e.apply(this,s),100)}}(()=>applyFilters());export function applySorting(t,s){const n=e.ui.sortOptions.find(e=>e.id===s);if(!n)return t;const a=[...t],{field:r,order:i}=n;return a.sort((e,t)=>{let s,n;switch(r){case"name":return s=e.name,n=t.name,"asc"===i?s.localeCompare(n):n.localeCompare(s);case"price":s=e.stats.medianPrice||e.stats.avgPrice||0,n=t.stats.medianPrice||t.stats.avgPrice||0;break;case"listingCount":s=e.stats.listingCount||0,n=t.stats.listingCount||0;break;case"avgDom":s=e.stats.avgDom||999,n=t.stats.avgDom||999}return"asc"===i?s-n:n-s}),a}export function applySortOnly(){const s=applySorting(t.allFilteredNeighborhoods,t.currentSort);t.allFilteredNeighborhoods=s,t.currentRenderCount=0;const n=document.getElementById("neighborhoodList");n&&(n.innerHTML=""),s.length>0&&(i(s.slice(0,e.data.batchSize)),t.currentRenderCount=e.data.batchSize);const a=document.getElementById("resultsCount");a&&(a.textContent=`${t.allFilteredNeighborhoods.length} ${1===t.allFilteredNeighborhoods.length?"match":"matches"} found!`)}let m=new Set,u=new Set;export function setupFilters(){const n=document.getElementById("price-min"),a=document.getElementById("price-max"),r=document.getElementById("price-display"),i=document.getElementById("price-fill");function o(){let o=parseInt(n.value),l=parseInt(a.value);isNaN(o)&&(o=0),isNaN(l)&&(l=41),o>l&&(this===a?(n.value=l,o=l):this===n?(a.value=o,l=o):(n.value=l,o=l));const c=e.ui.priceSteps[o],m=e.ui.priceSteps[l];0===o&&0===l?(t.filters.priceMin=null,t.filters.priceMax=null,r.textContent="$250K - $35M+"):(t.filters.priceMin=c,t.filters.priceMax=m,r.textContent=`${s(c)} - ${s(m)}${41===l?"+":""}`);const u=o/41,p=l/41;0===o?(i.style.left="0",i.style.width=100*p+"%"):(i.style.left=100*u+"%",i.style.width=100*(p-u)+"%"),d()}n.addEventListener("input",o),a.addEventListener("input",o);const l=document.getElementById("beds-min"),c=document.getElementById("beds-display"),m=document.getElementById("beds-fill");function u(){const e=parseInt(l.value);c.textContent=6===e?"6+":e+"+",t.filters.bedsMin=e;let s=(e-1)/5;m.style.width=100*s+"%",d()}l.addEventListener("input",u);const p=document.getElementById("baths-min"),h=document.getElementById("baths-display"),g=document.getElementById("baths-fill");function y(){const e=parseInt(p.value);h.textContent=6===e?"6+":e+"+",t.filters.bathsMin=e;let s=(e-1)/5;g.style.width=100*s+"%",d()}p.addEventListener("input",y),document.querySelectorAll("#areaFilters .amenity-tag").forEach(e=>{e.addEventListener("click",function(){this.classList.toggle("selected"),applyFilters()})}),document.querySelectorAll("#subareaFilters .amenity-tag").forEach(e=>{e.addEventListener("click",function(){this.classList.toggle("selected"),applyFilters()})});const f=new Set;t.neighborhoods.forEach(e=>{e.amenities&&Array.isArray(e.amenities)&&e.amenities.forEach(e=>f.add(e))});const b=["Short-Term","No Short-Term"],v=Array.from(f).filter(e=>!b.includes(e)).sort((e,t)=>e.localeCompare(t)).concat(b.filter(e=>f.has(e))),E=[],S=document.getElementById("amenityFilters");S&&(S.innerHTML="",v.forEach(e=>{const t=document.createElement("button");t.className="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium border border-neutral-300 dark:border-dark-border bg-white dark:bg-dark-bg-elevated text-neutral-700 dark:text-dark-text-primary hover:bg-brand-100 dark:hover:bg-brand-dark/20 hover:text-brand-700 dark:hover:text-brand-dark transition-colors cursor-pointer amenity-tag"+(E.includes(e)?" selected":""),t.textContent=e,t.setAttribute("data-amenity",e),t.addEventListener("click",function(){if("Short-Term"===e||"No Short-Term"===e){const t="Short-Term"===e?"No Short-Term":"Short-Term",s=Array.from(S.children).find(e=>e.getAttribute("data-amenity")===t);this.classList.contains("selected")?this.classList.remove("selected"):(s&&s.classList.remove("selected"),this.classList.add("selected"))}else this.classList.toggle("selected");applyFilters()}),S.appendChild(t)}));const I=document.getElementById("btn-homes"),B=document.getElementById("btn-condos");I&&I.addEventListener("click",function(){this.classList.toggle("active"),applyFilters()}),B&&B.addEventListener("click",function(){this.classList.toggle("active"),applyFilters()}),o(),u(),y()}export function applyFilters(){const s=new Set,d=new Set,p=new Set;let h=0,g=0,y=1,f=6,b=1,v=6;document.querySelectorAll("#areaFilters .amenity-tag.selected").forEach(e=>{s.add(e.getAttribute("data-zipcode"))}),document.querySelectorAll("#subareaFilters .amenity-tag.selected").forEach(e=>{d.add(e.getAttribute("data-subarea"))}),document.querySelectorAll("#amenityFilters .amenity-tag.selected").forEach(e=>{p.add(e.getAttribute("data-amenity"))});const E=document.getElementById("price-min"),S=document.getElementById("price-max");E&&S?0===parseInt(E.value)&&0===parseInt(S.value)?(h=0,g=Number.MAX_SAFE_INTEGER):(h=parseInt(e.ui.priceSteps[E.value]),g=41===parseInt(S.value)?Number.MAX_SAFE_INTEGER:parseInt(e.ui.priceSteps[S.value])):(h=0,g=Number.MAX_SAFE_INTEGER);const I=document.getElementById("beds-min");y=I?parseInt(I.value):0,f=6;const B=document.getElementById("baths-min");b=B?parseInt(B.value):0,v=6;const N=document.getElementById("btn-homes"),x=document.getElementById("btn-condos"),F=!!N&&N.classList.contains("active"),C=!!x&&x.classList.contains("active"),L=applySorting(t.neighborhoods.filter(e=>{let t=!0;(F||C)&&(t=!1,!F||"Homes"!==e.propertyType&&"Townhomes"!==e.propertyType||(t=!0),C&&"Condos"===e.propertyType&&(t=!0));let a=!0;const r=s.size>0,i=d.size>0;if(r||i){const t=r&&s.has(e.zipCode),n=i&&(d.has(e.area)||d.has(e.subArea));a=t||n}const o=0===p.size||[...p].every(t=>e.amenities.includes(t));let l=!1;const c=void 0!==e.stats.minPrice?parseFloat(e.stats.minPrice):null,m=void 0!==e.stats.maxPrice?parseFloat(e.stats.maxPrice):null;if(null===c||null===m||isNaN(c)||isNaN(m)){const t=n(e.stats.priceRange);l=t?g>=t.min&&h<=t.max:e.stats.avgPrice>0?e.stats.avgPrice>=h&&e.stats.avgPrice<=g:0===h}else l=g>=c&&h<=m;let u=!1;const f=void 0!==e.stats.minBeds?parseFloat(e.stats.minBeds):null,v=void 0!==e.stats.maxBeds?parseFloat(e.stats.maxBeds):null;if(null===f||null===v||isNaN(f)||isNaN(v)){const t=n(e.stats.bedsRange);u=t?t.max>=y:e.stats.avgSqft>0?e.stats.avgSqft>=300*y:1===y}else u=v>=y;let E=!1;const S=void 0!==e.stats.minBaths?parseFloat(e.stats.minBaths):null,I=void 0!==e.stats.maxBaths?parseFloat(e.stats.maxBaths):null;if(null===S||null===I||isNaN(S)||isNaN(I)){const t=n(e.stats.bathsRange);E=t?t.max>=b:e.stats.avgSqft>0?e.stats.avgSqft>=150*b:1===b}else E=I>=b;return t&&a&&o&&l&&u&&E}),t.currentSort);t.allFilteredNeighborhoods=L,t.currentRenderCount=0,document.getElementById("resultsCount").textContent="",t.markers.forEach(e=>e.marker.setMap(null)),t.markers=[],t.customBoundaries.forEach(e=>{s.has(e)||l(e)}),s.forEach(e=>{t.customBoundaries.has(e)||o(e)});const A=document.getElementById("neighborhoodList");if(A&&(A.innerHTML=""),0===L.length)document.getElementById("resultsCount").textContent="No communities found matching your criteria.";else{const n=a({areas:Array.from(s),amenities:Array.from(p)});history.replaceState(null,"",n),r(L),i(L.slice(t.currentRenderCount,t.currentRenderCount+e.data.batchSize)),t.currentRenderCount+=e.data.batchSize}const T=document.getElementById("resultsCount");T&&(T.textContent=`${t.allFilteredNeighborhoods.length} ${1===t.allFilteredNeighborhoods.length?"community":"communities"} found!`);const k=s.size!==m.size||![...s].every(e=>m.has(e)),w=d.size!==u.size||![...d].every(e=>u.has(e));(k||w)&&L.length>0&&setTimeout(()=>{console.log("Calling fitBoundsToNeighborhoods"),c(L,80),1!==s.size&&1!==d.size||setTimeout(()=>{t.map.getZoom()<13&&t.map.setZoom(13)},100)},200),m=new Set(s),u=new Set(d)}