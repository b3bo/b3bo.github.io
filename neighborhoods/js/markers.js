/**
 * @file markers.js
 * @description Logic for creating markers and handling InfoWindows.
 * @copyright 2025 Kimberly Bauman, P.A. All rights reserved.
 * @author John Bauman
 */
import{STATE as e}from"./state.js";import{CONFIG as r}from"./config.js";import{formatPrice as t,getUrlParams as o,toSlug as n}from"./utils.js";import{smoothFlyTo as a}from"./map.js?v=202501";export function createMarkerIcon(e,r=!1){const t=r?44:32,o=r?10:6;return{url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(`\n        <svg width="${t}" height="${t}" viewBox="0 0 ${t} ${t}" xmlns="http://www.w3.org/2000/svg">\n            ${r?`\n                \x3c!-- Animated ripple - starts from marker edge and pulses outward --\x3e\n                <circle cx="${t/2}" cy="${t/2}" r="${o}"\n                    fill="none"\n                    stroke="${e}"\n                    stroke-width="4"\n                    opacity="0.7">\n                    <animate attributeName="r"\n                        from="${o}"\n                        to="${t/2-2}"\n                        dur="1.5s"\n                        repeatCount="indefinite"/>\n                    <animate attributeName="opacity"\n                        from="0.7"\n                        to="0"\n                        dur="1.5s"\n                        repeatCount="indefinite"/>\n                </circle>\n            `:""}\n            \x3c!-- Main marker circle with white stroke --\x3e\n            <circle cx="${t/2}" cy="${t/2}" r="${o}"\n                fill="${e}"\n                stroke="white"\n                stroke-opacity="0.75"\n                stroke-width="${r?3:2}"/>\n        </svg>\n    `),scaledSize:new google.maps.Size(t,t),anchor:new google.maps.Point(t/2,t/2)}}const s="#4c8f96",d="#4a5462",i="#9ca3af";export function addMarkers(){e.markers.forEach(e=>e.marker.setMap(null)),e.markers=[],e.neighborhoods.forEach((r,t)=>{const o=r.searchIdHomes&&""!==r.searchIdHomes||r.searchIdCondos&&""!==r.searchIdCondos||r.searchIdTownhomes&&""!==r.searchIdTownhomes||r.searchIdLots&&""!==r.searchIdLots||r.searchId&&""!==r.searchId,n=r.urlSlug&&""!==r.urlSlug;let a="ripple-marker";a+=n?" has-urlslug":o?" has-searchid":" no-data";const l=n?s:o?d:i,c=new google.maps.Marker({position:r.position,map:e.map,title:r.name,icon:createMarkerIcon(l,!1),optimized:!1});c.markerColor=l,c.addListener("click",()=>{toggleMarker(c,r)}),c.addListener("mouseover",()=>{showInfoWindow(c,r,e.hoverInfoWindow)}),c.addListener("mouseout",()=>{e.hoverInfoWindow&&e.hoverInfoWindow.close()}),e.markers.push({marker:c,neighborhood:r})})}export function createMarkers(r){r.forEach(r=>{const t=r.searchIdHomes&&""!==r.searchIdHomes||r.searchIdCondos&&""!==r.searchIdCondos||r.searchIdTownhomes&&""!==r.searchIdTownhomes||r.searchIdLots&&""!==r.searchIdLots||r.searchId&&""!==r.searchId,o=r.urlSlug&&""!==r.urlSlug;let n="ripple-marker";n+=o?" has-urlslug":t?" has-searchid":" no-data";const a=o?s:t?d:i,l=new google.maps.Marker({position:r.position,map:e.map,title:r.name,icon:createMarkerIcon(a,!1),optimized:!1});l.markerColor=a,l.addListener("click",()=>{toggleMarker(l,r)}),l.addListener("mouseover",()=>{showInfoWindow(l,r,e.hoverInfoWindow)}),l.addListener("mouseout",()=>{e.hoverInfoWindow&&e.hoverInfoWindow.close()}),e.markers.push({marker:l,neighborhood:r})})}export function toggleMarker(r,t){e.activeMarker===r?e.infoWindow&&e.infoWindow.getMap()?(e.infoWindow.close(),r.setIcon(createMarkerIcon(r.markerColor,!1)),e.activeMarker=null):(showInfoWindow(r,t),r.setIcon(createMarkerIcon(r.markerColor,!0))):(e.activeMarker&&e.activeMarker.setIcon(createMarkerIcon(e.activeMarker.markerColor,!1)),showInfoWindow(r,t),r.setIcon(createMarkerIcon(r.markerColor,!0)),e.activeMarker=r)}export function showInfoWindow(r,a,s=e.infoWindow){if(s===e.infoWindow&&(window.currentNeighborhood=a),!a.stats)return void console.error("No stats data for neighborhood:",a.name);const d=a.stats.avgPricePerSqFt||(a.stats.avgSqft>0?Math.round(a.stats.avgPrice/a.stats.avgSqft):0),i=a.stats.medianPrice||a.stats.avgPrice,l=t(i);let c=a.listingsUrlMap||a.listingsUrl||a.marketReportUrl,h=a.listingsUrlList,m=null;if(!c){const r=(a.propertyType||"homes").toLowerCase();if(m=r.includes("townhome")?void 0!==a.searchIdTownhomes&&""!==a.searchIdTownhomes?a.searchIdTownhomes:a.searchId||null:r.includes("condo")?void 0!==a.searchIdCondos&&""!==a.searchIdCondos?a.searchIdCondos:a.searchId||null:r.includes("lot")||r.includes("land")||r.includes("vacant")?void 0!==a.searchIdLots&&""!==a.searchIdLots?a.searchIdLots:a.searchId||null:void 0!==a.searchIdHomes&&""!==a.searchIdHomes?a.searchIdHomes:a.searchId||null,m){const r=e.filters&&e.filters.bedsMin||1,t=e.filters&&e.filters.bathsMin||1,o=e.filters&&e.filters.priceMin,n=e.filters&&e.filters.priceMax,a="#"+((r>1?`beds_${r}/`:"")+(t>1?`baths_${t}/`:"")+(o?`lprice_${o}/`:"lprice_250000/")+(n&&n<35e6?`uprice_${n}/`:""));c=`https://www.truesouthcoastalhomes.com/property-search/results/?searchtype=3&searchid=${m}${a}`,h||(h=`https://www.truesouthcoastalhomes.com/property-search/results/?searchtype=2&searchid=${m}${a}`)}}const g=`\n        <div class="info-window p-3 max-w-sm bg-white dark:bg-dark-bg-elevated" style="cursor: pointer;">\n            <div class="flex items-center justify-center gap-2 mb-2">\n                <h3 class="text-lg font-semibold text-neutral-800 dark:text-dark-text-primary">\n                    ${a.name}\n                </h3>\n                ${a.urlSlug?`\n                <a href="https://www.truesouthcoastalhomes.com${a.urlSlug}"\n                   target="_blank"\n                   class="text-brand-500 dark:text-brand-dark hover:text-brand-600 dark:hover:text-brand-dark-hover transition-colors"\n                   onclick="event.stopPropagation();"\n                   title="View Neighborhood Page">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>\n                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>\n                    </svg>\n                </a>\n                `:""}\n            </div>\n\n            <div class="grid grid-cols-2 gap-2 mb-2">\n                <div class="bg-neutral-50 dark:bg-dark-bg-elevated-2 px-3 py-2 rounded-lg border border-neutral-200 dark:border-dark-border">\n                    <div class="text-sm font-semibold text-neutral-800 dark:text-dark-text-primary mb-0.5">${a.stats.listingCount}</div>\n                    <div class="text-xs text-neutral-600 dark:text-dark-text-secondary">All Active</div>\n                </div>\n                <div class="bg-neutral-50 dark:bg-dark-bg-elevated-2 px-3 py-2 rounded-lg border border-neutral-200 dark:border-dark-border">\n                    <div class="text-sm font-semibold text-neutral-800 dark:text-dark-text-primary mb-0.5">${l}</div>\n                    <div class="text-xs text-neutral-600 dark:text-dark-text-secondary">Med List Price</div>\n                </div>\n            </div>\n\n            <div class="grid grid-cols-2 gap-2 mb-2">\n                <div class="bg-neutral-50 dark:bg-dark-bg-elevated-2 px-3 py-2 rounded-lg border border-neutral-200 dark:border-dark-border">\n                    <div class="text-sm font-semibold text-neutral-800 dark:text-dark-text-primary mb-0.5">$${d.toLocaleString()}</div>\n                    <div class="text-xs text-neutral-600 dark:text-dark-text-secondary">Avg $/Sq Ft</div>\n                </div>\n                <div class="bg-neutral-50 dark:bg-dark-bg-elevated-2 px-3 py-2 rounded-lg border border-neutral-200 dark:border-dark-border">\n                    <div class="text-sm font-semibold text-neutral-800 dark:text-dark-text-primary mb-0.5">${a.stats.avgDom}</div>\n                    <div class="text-xs text-neutral-600 dark:text-dark-text-secondary">Avg DOM</div>\n                </div>\n            </div>\n\n            ${a.amenities&&a.amenities.length>0?`\n            <div class="mb-3">\n                <div class="bg-neutral-50 dark:bg-dark-bg-elevated-2 p-3 rounded-lg border border-neutral-200 dark:border-dark-border">\n                    <div class="text-sm font-semibold text-neutral-800 dark:text-dark-text-primary mb-1">Amenities</div>\n                    <div class="text-xs text-neutral-600 dark:text-dark-text-secondary leading-relaxed">${a.amenities.join(", ")}</div>\n                </div>\n            </div>\n            `:""}\n\n            <hr class="divider mb-3">\n            <div class="pt-3 flex items-center gap-2">\n                ${e.allFilteredNeighborhoods.length>1?'\n                <button onclick="window.navigateNeighborhood(-1)" class="p-2 rounded-full hover:bg-neutral-100 dark:hover:bg-dark-bg-elevated-2 text-neutral-600 dark:text-dark-text-secondary transition-colors flex-shrink-0" title="Previous Community">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>\n                </button>\n                ':""}\n\n                ${(()=>{const e="single"===o().mode;if(c){if(e){const e=n(a.name),r=a.propertyType?`&propertyType=${encodeURIComponent(a.propertyType)}`:"";return`\n                            <a href="${"localhost"===window.location.hostname?window.location.origin:"https://neighborhoods.truesouthcoastalhomes.com"}/?marker=${e}${r}"\n                               target="_blank"\n                               class="flex items-center justify-center gap-2 flex-1 bg-brand-500 dark:bg-brand-dark hover:bg-brand-600 dark:hover:bg-brand-dark-hover text-white py-2.5 px-4 rounded-lg font-medium transition-colors"\n                               onclick="event.stopPropagation();"\n                               title="Open ${a.name} in Community Finder">\n                                Community Finder\n                                <svg style="width: 1rem; height: 1rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />\n                                </svg>\n                            </a>\n                            `}return`\n                            <a href="${c}"\n                               target="_blank"\n                               class="flex-1 text-center bg-brand-500 dark:bg-brand-dark hover:bg-brand-600 dark:hover:bg-brand-dark-hover text-white py-2.5 px-4 rounded-lg font-medium transition-colors"\n                               onclick="event.stopPropagation();"\n                               title="View all ${a.name} ${a.propertyType} for sale">\n                                Matching Listings\n                            </a>\n                            `}return`\n                        <button class="flex-1 bg-neutral-300 dark:bg-dark-bg-elevated-2 text-neutral-500 dark:text-dark-text-secondary py-2.5 px-4 rounded-lg font-medium opacity-50 cursor-not-allowed"\n                                disabled\n                                title="MLS listings coming soon for ${a.name}">\n                            Coming Soon!\n                        </button>\n                        `})()}\n\n                ${e.allFilteredNeighborhoods.length>1?'\n                <button onclick="window.navigateNeighborhood(1)" class="p-2 rounded-full hover:bg-neutral-100 dark:hover:bg-dark-bg-elevated-2 text-neutral-600 dark:text-dark-text-secondary transition-colors flex-shrink-0" title="Next Community">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>\n                </button>\n                ':""}\n            </div>\n        </div>\n    `;s.close(),s.setContent(g),s.open(e.map,r),s===e.infoWindow&&(google.maps.event.clearListeners(e.infoWindow,"closeclick"),e.infoWindow.addListener("closeclick",()=>{e.activeMarker&&e.activeMarker.setIcon(createMarkerIcon(e.activeMarker.markerColor,!1)),e.activeMarker=null}))}