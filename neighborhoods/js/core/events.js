/**
 * @file core/events.js
 * @description Centralized event delegation for performance and memory efficiency.
 * @copyright 2025 Kimberly Bauman, P.A. All rights reserved.
 */
import{eventBus as e,Events as t}from"./eventBus.js";import{updatePriceSlider as n}from"../filters/index.js";import{formatSliderPrice as i}from"../utils.js";const s=new Map,o=new Map,a=new Map;export function onClick(e,t){return s.has(e)||s.set(e,new Set),s.get(e).add(t),()=>s.get(e)?.delete(t)}export function onKeydown(e,t){return o.has(e)||o.set(e,new Set),o.get(e).add(t),()=>o.get(e)?.delete(t)}export function onInput(e,t){return a.has(e)||a.set(e,new Set),a.get(e).add(t),()=>a.get(e)?.delete(t)}function l(e,t){return"document"===t?document.documentElement:e.closest(t)}function c(e,t){for(const[n,i]of e){const e=l(t.target,n);if(e)for(const s of i)try{if(s(t,e),t.defaultPrevented)return}catch(e){console.error(`Error in ${t.type} handler for "${n}":`,e)}}}export function initEventDelegation(){document.addEventListener("click",e=>{c(s,e)},{capture:!1}),document.addEventListener("keydown",e=>{c(o,e)},{capture:!1}),document.addEventListener("input",e=>{c(a,e)},{capture:!1}),console.log("Event delegation initialized")}export function registerCommonHandlers(){onClick(".menu-item",(n,i)=>{const s=i.dataset.panel;if(!s)return;const o=document.getElementById(s+"-panel")||document.getElementById(s),a=document.getElementById("main-menu");o&&(window.lastFocusedMenuItem=i,o.classList.remove("translate-x-full"),a&&(a.style.display="none"),setTimeout(()=>{const e=o.querySelector('button, input, [tabindex="0"]');e?.focus();const t=o.querySelector(".panel-content");t&&(t.scrollHeight>t.clientHeight+4?t.classList.add("has-overflow"):t.classList.remove("has-overflow"))},100),e.emit(t.PANEL_OPENED,{panelId:s}))}),onClick('.sliding-panel button[onclick*="translate-x-full"]',(n,i)=>{const s=i.closest(".sliding-panel"),o=document.getElementById("main-menu");s&&(s.classList.add("translate-x-full"),o&&(o.style.removeProperty("display"),o.scrollTop=0,window.lastFocusedMenuItem&&setTimeout(()=>window.lastFocusedMenuItem.focus(),50)),e.emit(t.PANEL_CLOSED,{panelId:s.id}))}),onClick(".sort-option",(e,t)=>{const n=t.querySelector('input[type="radio"]');n&&!n.checked&&(n.checked=!0,n.dispatchEvent(new Event("change",{bubbles:!0})))}),onClick("#homes-btn, #condos-btn",(n,i)=>{const s=i.classList.contains("filter-btn-active");i.classList.toggle("filter-btn-active",!s),i.classList.toggle("filter-btn-inactive",s),window.applyFilters&&window.applyFilters(),e.emit(t.FILTERS_CHANGED,{type:"propertyType"})}),onClick(".amenity-tag",(n,i)=>{if(i.classList.contains("price-preset"))return;const s=i.classList.contains("filter-btn-active");i.classList.toggle("filter-btn-active",!s),i.classList.toggle("filter-btn-inactive",s);const o=i.dataset.opposite;if(o&&!s){const e=document.getElementById(o);e&&(e.classList.remove("filter-btn-active"),e.classList.add("filter-btn-inactive"))}window.applyFilters&&window.applyFilters(),e.emit(t.FILTERS_CHANGED,{type:"amenity"})}),onClick(".area-tag",(n,i)=>{const s=i.classList.contains("filter-btn-active");i.classList.toggle("filter-btn-active",!s),i.classList.toggle("filter-btn-inactive",s);const o=i.dataset.zipcode;o&&(!s&&window.showCustomBoundary?window.showCustomBoundary(o):s&&window.hideCustomBoundary&&window.hideCustomBoundary(o)),window.applyFilters&&window.applyFilters(),e.emit(t.FILTERS_CHANGED,{type:"area"})}),onClick("#search-results .search-result",(e,t)=>{window.handleSearchResultClick&&window.handleSearchResultClick(t)}),onKeydown("document",e=>{"Escape"===e.key&&window.handleEscapeKey&&window.handleEscapeKey()}),onKeydown("document",e=>{"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||window.infoWindow?.getMap()&&window.navigateNeighborhood&&(e.preventDefault(),window.navigateNeighborhood("ArrowLeft"===e.key?-1:1))}),onInput("#price-min, #price-max, #beds-slider, #baths-slider",(e,t)=>{window.applyFilters&&(clearTimeout(window._filterDebounce),window._filterDebounce=setTimeout(()=>window.applyFilters(),50))}),onClick(".price-preset",(n,s)=>{const o=document.getElementById("price-min"),a=document.getElementById("price-max"),l=Array.from(document.querySelectorAll(".price-preset")),c=parseInt(s.dataset.min,10),r=parseInt(s.dataset.max,10);if(s.classList.contains("selected")){s.classList.remove("selected");const e=l.filter(e=>e.classList.contains("selected"));if(0===e.length)o&&a&&(o.value=0,a.value=0);else{let t=41,n=0;e.forEach(e=>{t=Math.min(t,parseInt(e.dataset.min,10)),n=Math.max(n,parseInt(e.dataset.max,10))}),o&&a&&(o.value=t,a.value=n)}}else{const e=l.filter(e=>e.classList.contains("selected"));if(0===e.length)s.classList.add("selected"),o&&a&&(o.value=c,a.value=r);else{let t=41,n=0;if(e.forEach(e=>{t=Math.min(t,parseInt(e.dataset.min,10)),n=Math.max(n,parseInt(e.dataset.max,10))}),r===t||c===n){s.classList.add("selected");const e=Math.min(t,c),i=Math.max(n,r);o&&a&&(o.value=e,a.value=i)}else l.forEach(e=>{e.classList.remove("selected")}),s.classList.add("selected"),o&&a&&(o.value=c,a.value=r)}}const d=parseInt(o?.value)||0,u=parseInt(a?.value)||0,p=window.PRICE_STEPS||[],m=document.getElementById("price-display"),w=document.getElementById("price-fill");if(window.filterState.priceMin=d,window.filterState.priceMax=u,m)if(0===d&&0===u)m.textContent="$250K - $35M+";else{const e=p[d]||p[0]||25e4,t=p[u]||p[p.length-1]||35e6;m.textContent=`${i(e)} - ${i(t)}${41===u?"+":""}`}if(w){const e=41,t=d/e,n=u/e;w.style.left=0===d?"0":100*t+"%",w.style.width=100*(0===u?0:n-t)+"%"}window.applyFilters&&window.applyFilters(),e.emit(t.FILTERS_CHANGED,{type:"pricePreset"})}),setTimeout(()=>{const e=document.getElementById("main-menu");e&&e.scrollHeight>e.clientHeight+4&&e.classList.add("has-overflow")},200)}export function getHandlerCounts(){return{click:Array.from(s.values()).reduce((e,t)=>e+t.size,0),keydown:Array.from(o.values()).reduce((e,t)=>e+t.size,0),input:Array.from(a.values()).reduce((e,t)=>e+t.size,0)}}"undefined"!=typeof window&&(window._eventDelegation={onClick:onClick,onKeydown:onKeydown,onInput:onInput,getHandlerCounts:getHandlerCounts});