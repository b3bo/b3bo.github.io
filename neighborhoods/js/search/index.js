/**
 * @file search/index.js
 * @description Neighborhood search with debounced input and result highlighting.
 * @copyright 2025 Kimberly Bauman, P.A. All rights reserved.
 */
import{eventBus as e,Events as t}from"../core/eventBus.js";let o=null;export function highlightMatch(e,t){if(!t)return e;const o=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=new RegExp(`(${n})`,"ig");return o.replace(r,"<strong>$1</strong>")}export function getDefaultSearchResults(){return[...window.neighborhoods||[]].sort((e,t)=>(t.stats?.listingCount||0)-(e.stats?.listingCount||0)).slice(0,5)}export function searchNeighborhoods(e){return e?(window.neighborhoods||[]).filter(t=>t.name.toLowerCase().includes(e)||(t.location?.city||"").toLowerCase().includes(e)||(t.zipCode||"").includes(e)).sort((t,o)=>{const n=t.name.toLowerCase().includes(e)?0:1,r=o.name.toLowerCase().includes(e)?0:1;return n!==r?n-r:t.name.localeCompare(o.name)}):getDefaultSearchResults()}export function renderSearchResults(e,t){if(!e)return;const o=(t||"").toLowerCase();if(o){const n=searchNeighborhoods(o);n.length?e.innerHTML=n.map(e=>`\n                <button class="search-result w-full text-left px-4 py-2 text-sm hover:bg-brand-100 dark:hover:bg-brand-dark/20 transition-colors cursor-pointer" data-name="${e.name}" data-type="${e.propertyType}">\n                    ${highlightMatch(e.name,t)} - ${highlightMatch(e.propertyType,t)}\n                </button>\n            `).join(""):e.innerHTML='<div class="px-4 py-3 text-sm text-neutral-400">No matches found</div>'}else{const t=getDefaultSearchResults();e.innerHTML=`\n            <div class="px-4 py-2 text-xs font-medium text-neutral-400 dark:text-dark-text-secondary uppercase">Most Listings</div>\n            ${t.map(e=>`\n                <button class="search-result w-full text-left px-4 py-2 text-sm hover:bg-brand-100 dark:hover:bg-brand-dark/20 transition-colors cursor-pointer" data-name="${e.name}" data-type="${e.propertyType}">\n                    ${e.name} - ${e.propertyType}\n                </button>\n            `).join("")}\n        `}e.scrollHeight>e.clientHeight+4?e.classList.add("has-overflow"):e.classList.remove("has-overflow")}export function handleSearchInput(n){const r=n.target.value.trim(),a=r.toLowerCase(),s=document.getElementById("search-results");a&&"undefined"!=typeof gtag&&(clearTimeout(o),o=setTimeout(()=>{gtag("event","search_filter",{search_term:a})},500)),renderSearchResults(s,r),window.searchQuery=a,window.filteredNeighborhoods=a?(window.neighborhoods||[]).filter(e=>e.name.toLowerCase().includes(a)):[...window.neighborhoods||[]],window.renderResults&&window.renderResults(),window.addMarkers&&window.addMarkers(),e.emit(t.SEARCH_PERFORMED,{query:a,resultCount:window.filteredNeighborhoods.length})}export function handleSearchResultClick(o){const n=o.dataset.name,r=o.dataset.type,a=document.getElementById("search-input"),s=document.getElementById("search-dropdown"),i=(window.neighborhoods||[]).find(e=>e.name===n&&e.propertyType===r);if(i&&window.map){"undefined"!=typeof gtag&&gtag("event","search_select",{neighborhood_name:i.name,search_query:a?.value||""}),window.smoothFlyTo&&window.smoothFlyTo(i.position);const e=(window.markers||[]).find(e=>e.neighborhood.name===n&&e.neighborhood.propertyType===r);if(e){const t=window.map.getCenter(),o=new google.maps.LatLng(i.position),n=google.maps.geometry.spherical.computeDistanceBetween(t,o);setTimeout(()=>{google.maps.event.trigger(e.marker,"click")},n<2e3?450:2200)}}s&&s.classList.add("hidden"),a&&(a.value=""),window.searchQuery="",window.filteredNeighborhoods=[...window.neighborhoods||[]],window.renderResults&&window.renderResults(),window.addMarkers&&window.addMarkers(),e.emit(t.SEARCH_RESULT_SELECTED,{name:n,type:r})}export function clearSearch(){const e=document.getElementById("search-input"),t=document.getElementById("search-dropdown");e&&(e.value=""),t&&t.classList.add("hidden"),window.searchQuery="",window.filteredNeighborhoods=[...window.neighborhoods||[]],window.renderResults&&window.renderResults(),window.addMarkers&&window.addMarkers()}"undefined"!=typeof window&&(window.handleSearchInput=handleSearchInput,window.handleSearchResultClick=handleSearchResultClick,window.highlightMatch=highlightMatch,window.searchNeighborhoods=searchNeighborhoods,window.clearSearch=clearSearch);