/**
 * @file ui/infoWindow.js
 * @description Info window content templates for Google Maps markers.
 * @copyright 2025 Kimberly Bauman, P.A. All rights reserved.
 */
import{eventBus as n,Events as o}from"../core/eventBus.js";import{formatPrice as t,getAreaStats as i,getAreaNeighborhoods as e}from"../utils.js";function s(n){const o=n.name,t=(n.propertyType||"").toLowerCase();return"homes"===t?`${o} Homes`:"condos"===t?`${o} Condos`:"townhomes"===t?`${o} T/H`:"lots"===t?`${o} Lots`:o}export function showPresetInfoWindowContent(n,o,e,a={}){const{skipCentering:d=!1}=a;if(console.log("[infoWindow.js showPresetInfoWindowContent] Called with skipCentering:",d),window.useMiniInfoWindow)return showMiniInfoWindowContent(n,o,e);if(d){console.log("[infoWindow.js showPresetInfoWindowContent] Attempting DOM-only update...");const n=function(n){console.log("[infoWindow.js updateInfoWindowStatsOnly] Called with area:",n.name,"propertyType:",n.propertyType);const o=i(n,n.propertyType);console.log("[infoWindow.js updateInfoWindowStatsOnly] Stats to apply:",o);const e=document.querySelector(".info-window");if(!e)return console.log("[infoWindow.js updateInfoWindowStatsOnly] ERROR: No .info-window element found"),!1;console.log("[infoWindow.js updateInfoWindowStatsOnly] Found .info-window element");const a=e.querySelector(".info-window-title");a&&(a.textContent=s(n),console.log("[infoWindow.js updateInfoWindowStatsOnly] Updated title to:",a.textContent));const d=e.querySelector('[data-stat="listingCount"]'),r=e.querySelector('[data-stat="medianPrice"]'),l=e.querySelector('[data-stat="avgPricePerSqFt"]'),w=e.querySelector('[data-stat="avgDom"]');return console.log("[infoWindow.js updateInfoWindowStatsOnly] Found stat elements:",{listingCount:!!d,medianPrice:!!r,avgPricePerSqFt:!!l,avgDom:!!w}),d&&r&&l&&w?(d.textContent=o.listingCount||0,r.textContent=t(o.medianPrice||0),l.textContent="$"+(o.avgPricePerSqFt||0),w.textContent=o.avgDom||0,console.log("[infoWindow.js updateInfoWindowStatsOnly] SUCCESS: Stats updated via DOM"),!0):(console.log("[infoWindow.js updateInfoWindowStatsOnly] ERROR: Could not find all stat elements with data attributes"),!1)}(o);if(console.log("[infoWindow.js showPresetInfoWindowContent] DOM update result:",n),n)return void console.log("[infoWindow.js showPresetInfoWindowContent] SUCCESS: Stats updated via DOM-only method, returning early");console.log("[infoWindow.js showPresetInfoWindowContent] FALLBACK: DOM update failed, continuing with full render")}const r=i(o,o.propertyType),l=(o.neighborhoods||[]).slice(0,10).map(n=>n.name).join(", "),w=`\n        <div class="info-window">\n            <h3 class="info-window-title">${s(o)}</h3>\n            <div class="info-window-stats">\n                <div class="info-window-stat">\n                    <div class="info-window-stat-value" data-stat="listingCount">${r.listingCount||0}</div>\n                    <div class="info-window-stat-label">Active</div>\n                </div>\n                <div class="info-window-stat">\n                    <div class="info-window-stat-value" data-stat="medianPrice">${t(r.medianPrice||0)}</div>\n                    <div class="info-window-stat-label">Median</div>\n                </div>\n                <div class="info-window-stat">\n                    <div class="info-window-stat-value" data-stat="avgPricePerSqFt">$${r.avgPricePerSqFt||0}</div>\n                    <div class="info-window-stat-label">$/SF</div>\n                </div>\n                <div class="info-window-stat">\n                    <div class="info-window-stat-value" data-stat="avgDom">${r.avgDom||0}</div>\n                    <div class="info-window-stat-label">Avg DOM</div>\n                </div>\n            </div>\n            <div class="info-window-section">\n                <div class="info-window-section-title">Top Neighborhoods</div>\n                <div class="communities-scroll info-window-section-content">${l}</div>\n            </div>\n            <hr class="divider">\n            <div class="info-window-nav">\n                ${function(n){const o=(window.filteredNeighborhoods||[]).length>1,t=o?'<button id="nav-prev" onclick="window.navigateNeighborhood(-1)" class="info-window-nav-btn" title="Previous Community"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>':"",i=o?'<button id="nav-next" onclick="window.navigateNeighborhood(1)" class="info-window-nav-btn" title="Next Community"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>':"";if(window.isSingleMode)return t+'<a href="'+("localhost"===window.location.hostname?window.location.origin:"https://neighborhoods.truesouthcoastalhomes.com")+"?marker="+n.name.toLowerCase().replace(/[^a-z0-9]+/g,"-")+(n.propertyType?"&propertyType="+encodeURIComponent(n.propertyType):"")+'" target="_blank" class="info-window-action-btn" title="Open '+n.name+' in Neighborhood Finder">Neighborhood Finder&trade; <svg style="display:inline;width:1.1em;height:1.1em;vertical-align:middle;margin-left:2px" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>'+i;{const o=(window.areaPresets?.presets||[]).find(o=>o.name===n.name);return t+'<a href="https://www.truesouthcoastalhomes.com/property-search/results/?searchtype=3#listtype_1/'+(o?.listingsParam||"area_"+encodeURIComponent(n.name)+"/")+'" target="_blank" class="info-window-action-btn" onclick="event.stopPropagation();" title="View all '+n.name+' listings">Matching Listings</a>'+i}}(o)}\n            </div>\n        </div>\n    `;e.setContent(w),d||e.open(window.map,n),google.maps.event.addListenerOnce(e,"domready",()=>{const o=document.querySelector(".communities-scroll");o&&o.scrollHeight>o.clientHeight+4&&o.classList.add("has-overflow"),window.isSingleMode||d||!n?.position||requestAnimationFrame(()=>{window.applyCenteringFromRenderedCard&&window.applyCenteringFromRenderedCard(n.position,{maxRetries:30,usePaddingMethod:!1,onComplete:()=>{setTimeout(()=>{window.logCenteringDiagnostics&&window.logCenteringDiagnostics(n.position)},100)}})})})}export function showNeighborhoodInfoWindowContent(i,e,a,d=!0){if(e.isAreaMarker)return showPresetInfoWindowContent(i,e,a);if(window.useMiniInfoWindow)return showMiniInfoWindowContent(i,e,a);d&&a===window.infoWindow&&(window.currentNeighborhood=e);const r=e.stats||{},l=r.medianPrice||r.avgPrice||0,w=t(l),c=r.avgPricePerSqFt||(r.avgSqft>0?Math.round((r.avgPrice||0)/r.avgSqft):0),p=(e.propertyType,"Active"),v=window.filterState&&window.filterState.amenities?window.filterState.amenities:new Set,h=function(n){const o=(n.propertyType||"homes").toLowerCase(),t=window.filterState||{},i=window.PRICE_STEPS||[],e=t.bedsMin||1,s=t.bathsMin||1,a=t.priceMin>0?i[t.priceMin]:null,d=t.priceMax<41?i[t.priceMax]:null,r=e>1?`beds_${e}/`:"",l=s>1?`baths_${s}/`:"",w=a?`lprice_${a}/`:"",c=d&&d<35e6?`uprice_${d}/`:"";let p="";p=o.includes("townhome")?"listtypedescrip_attached%20single%20unit/":o.includes("condo")?"listtypedescrip_condominium/":o.includes("lot")||o.includes("land")||o.includes("vacant")?"":"listtypedescrip_detached%20single%20family/";let v="listtype_1";(o.includes("lot")||o.includes("land")||o.includes("vacant"))&&(v="listtype_4");const h=`#${v}/${w}${c}${r}${l}${p}`,g=n=>{return(o=n,o.toLowerCase().replace(/\b\w/g,n=>n.toUpperCase())).replace(/ /g,"+").replace(/&/g,"%26%");var o};let u;return u=n.mlsSubdivisions&&n.mlsSubdivisions.length>0?`subdivision=${n.mlsSubdivisions.map(g).join(",")}`:`subdivision=${g(n.name)}`,`https://www.truesouthcoastalhomes.com/property-search/results/?searchtype=3&${u}${h}`}(e),g=(window.filteredNeighborhoods||[]).length>1,u=`\n        <div class="info-window" style="cursor: pointer;" tabindex="-1">\n            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;">\n                <h3 class="info-window-title" style="margin-bottom: 0;">${s(e)}</h3>\n                ${e.urlSlug?`\n                <a href="https://www.truesouthcoastalhomes.com${e.urlSlug}"\n                   target="_blank"\n                   style="color: var(--color-brand-base); flex-shrink: 0;"\n                   onclick="event.stopPropagation();"\n                   title="${e.name} ${e.propertyType} for Sale">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>\n                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>\n                    </svg>\n                </a>\n                `:""}\n            </div>\n            <div class="info-window-stats">\n                <div class="info-window-stat">\n                    <div class="info-window-stat-value">${r.listingCount||0}</div>\n                    <div class="info-window-stat-label">${p}</div>\n                </div>\n                <div class="info-window-stat">\n                    <div class="info-window-stat-value">${w}</div>\n                    <div class="info-window-stat-label">Median</div>\n                </div>\n                <div class="info-window-stat">\n                    <div class="info-window-stat-value">$${c.toLocaleString()}</div>\n                    <div class="info-window-stat-label">$/SF</div>\n                </div>\n                <div class="info-window-stat">\n                    <div class="info-window-stat-value">${r.avgDom||0}</div>\n                    <div class="info-window-stat-label">Avg DOM</div>\n                </div>\n            </div>\n            ${(e.amenities||[]).length>0?`\n            <div class="info-window-section">\n                <div class="info-window-section-title">Amenities</div>\n                <div class="amenities-scroll info-window-section-content">${((n=[])=>n.map(n=>{const o=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return v.has(n)?`<strong>${o}</strong>`:o}).join(", ")+".")(e.amenities||[])}</div>\n            </div>\n            `:""}\n            <hr class="divider">\n            <div class="info-window-nav">\n                ${g?'\n                <button id="nav-prev" onclick="window.navigateNeighborhood(-1)" class="info-window-nav-btn" title="Previous Community">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>\n                </button>\n                ':""}\n                ${function(n,o){const t=n.stats||{};if(window.isSingleMode){const o=window.toSlug?window.toSlug(n.name):n.name.toLowerCase().replace(/[^a-z0-9]+/g,"-"),t=n.propertyType?"&propertyType="+encodeURIComponent(n.propertyType):"";return'<a href="'+("localhost"===window.location.hostname?window.location.origin:"https://neighborhoods.truesouthcoastalhomes.com")+"?marker="+o+t+'" target="_blank" class="info-window-action-btn" title="Open '+n.name+' in Neighborhood Finder">Neighborhood Finder&trade; <svg style="display:inline;width:1.1em;height:1.1em;vertical-align:middle;margin-left:2px" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>'}return o?'<a href="'+o+"\" target=\"_blank\" class=\"info-window-action-btn\" onclick=\"event.stopPropagation(); if(typeof gtag!=='undefined')gtag('event','view_listings',{neighborhood_name:'"+n.name+"',listing_count:"+(t.listingCount||0)+",property_type:'"+n.propertyType+'\'});" title="View all '+n.name+" "+n.propertyType+' for sale">Matching Listings</a>':'<button class="info-window-action-btn disabled" disabled title="MLS listings coming soon for '+n.name+'">Coming Soon!</button>'}(e,h)}\n                ${g?'\n                <button id="nav-next" onclick="window.navigateNeighborhood(1)" class="info-window-nav-btn" title="Next Community">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>\n                </button>\n                ':""}\n            </div>\n        </div>\n    `;a.setContent(u),a.open(window.map,i),n.emit(o.INFO_WINDOW_OPENED,{neighborhood:e})}export function showMiniInfoWindowContent(n,o,t){const e=o.isAreaMarker?i(o,o.propertyType):o.stats||{},a=o.propertyType||window.filterState?.propertyType||"Homes",d=window.toSlug?window.toSlug(o.name):o.name.toLowerCase().replace(/[^a-z0-9]+/g,"-"),r=a?"&propertyType="+encodeURIComponent(a):"",l=("localhost"===window.location.hostname?window.location.origin:"https://neighborhoods.truesouthcoastalhomes.com")+"?marker="+d+r,w=`\n        <div class="info-window info-window-mini">\n            <h3 class="info-window-title">${s(o)}</h3>\n            <div class="info-window-stat">\n                <div class="info-window-stat-value">${e.listingCount||0}</div>\n                <div class="info-window-stat-label">Active</div>\n            </div>\n            <hr class="divider">\n            <div class="info-window-nav">\n                <a href="${l}" target="_blank" class="info-window-action-btn" title="Open ${o.name} in Neighborhood Finder">\n                    <span>Neighborhood</span>\n                    <span>Finder&trade; <svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></span>\n                </a>\n            </div>\n        </div>\n    `;t.setContent(w),t.open(window.map,n)}"undefined"!=typeof window&&(window.showNeighborhoodInfoWindowContent=showNeighborhoodInfoWindowContent,window.showPresetInfoWindowContent=showPresetInfoWindowContent,window.showMiniInfoWindowContent=showMiniInfoWindowContent);