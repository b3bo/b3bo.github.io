/**
 * @file ui.js
 * @description Handles UI rendering, list items, and event listeners.
 * @copyright 2025 Kimberly Bauman, P.A. All rights reserved.
 * @author John Bauman
 */
import{STATE as e}from"./state.js";import{CONFIG as t}from"./config.js";import{formatPrice as o}from"./utils.js";import{smoothFlyTo as n}from"./map.js?v=202501";import{applySortOnly as r}from"./filters.js";export function renderListItems(r){const i=document.getElementById("neighborhoodList");r.forEach(r=>{const s=e.markers.find(e=>e.neighborhood===r),a=s?s.marker:null;if(i){const s=r.stats.medianPrice||r.stats.avgPrice,d=o(s),l=document.createElement("div");l.className="bg-white dark:bg-dark-bg-elevated px-4 py-3 rounded-xl border border-neutral-200 dark:border-dark-border cursor-pointer overflow-hidden transition-colors hover:bg-brand-100 dark:hover:bg-brand-dark/20 active:bg-brand-200 dark:active:bg-brand-dark/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500 dark:focus-visible:ring-brand-dark",l.setAttribute("role","button"),l.tabIndex=0,l.innerHTML=`\n                <div class="flex justify-between items-start gap-2 mb-1">\n                    <h3 class="text-base font-semibold text-neutral-800 dark:text-dark-text-primary break-words">${r.name}</h3>\n                    <span class="text-sm font-semibold text-neutral-800 dark:text-dark-text-primary whitespace-nowrap">${d}</span>\n                </div>\n                <div class="text-xs text-neutral-600 dark:text-dark-text-secondary mb-3">${r.stats.listingCount} Listings</div>\n                <div class="text-xs text-neutral-600 dark:text-dark-text-secondary leading-relaxed break-words">\n                    ${r.amenities.join(", ")}\n                </div>\n            `,l.addEventListener("click",()=>{if(!a)return;e.infoWindow&&e.infoWindow.getMap()&&e.infoWindow.close(),e.activeMarker=null;const o=e.map.getCenter(),i=new google.maps.LatLng(r.position),s=google.maps.geometry.spherical.computeDistanceBetween(o,i)<2e3;n(r.position,15),t.map.autoOpenOnFly&&setTimeout(()=>{google.maps.event.trigger(a,"click")},s?450:2200),window.innerWidth<768&&(document.getElementById("drawer-toggle").checked=!1)}),l.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),l.click())}),i.appendChild(l)}})}export function navigateNeighborhood(t){if(event&&event.stopPropagation(),!window.currentNeighborhood||!e.allFilteredNeighborhoods.length)return;const o=e.allFilteredNeighborhoods.indexOf(window.currentNeighborhood);if(-1===o)return;let r=o+t;r<0&&(r=e.allFilteredNeighborhoods.length-1),r>=e.allFilteredNeighborhoods.length&&(r=0);const i=e.allFilteredNeighborhoods[r],s=e.markers.find(e=>e.neighborhood===i);if(s){const t=s.marker;e.infoWindow&&e.infoWindow.getMap()&&e.infoWindow.close(),e.activeMarker&&(e.activeMarker=null);const o=e.map.getCenter(),r=new google.maps.LatLng(i.position),a=google.maps.geometry.spherical.computeDistanceBetween(o,r)<2e3;n(i.position,15),a?setTimeout(()=>{google.maps.event.trigger(t,"click")},450):setTimeout(()=>{google.maps.event.trigger(t,"click")},2200)}}export function setupUI(){!function(){const o=document.getElementById("sort-button"),n=document.getElementById("sort-menu");o&&n?(console.log("Setting up sort dropdown"),n.innerHTML=t.ui.sortOptions.map(t=>{const o=e.currentSort===t.id;return`\n            <button class="sort-option w-full flex items-center justify-between px-4 py-2 text-sm cursor-pointer gap-2 text-left hover:bg-brand-100 dark:hover:bg-brand-dark/20 rounded-md transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500 dark:focus-visible:ring-brand-dark ${o?"active bg-brand-200 dark:bg-brand-dark/30 text-brand-700 dark:text-brand-dark font-medium":"text-neutral-600 font-normal"}" data-sort-id="${t.id}" type="button">\n                <span class="truncate">${t.label}</span>\n                ${o?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="ml-3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>':""}\n            </button>\n        `}).join(""),n.dataset&&"true"===n.dataset.portal||o.addEventListener("click",e=>{e.stopPropagation(),n.classList.toggle("hidden")}),document.addEventListener("click",e=>{o.contains(e.target)||n.contains(e.target)||n.classList.add("hidden")}),n.addEventListener("click",o=>{o.stopPropagation();const i=o.target.closest(".sort-option");if(!i)return;const s=i.getAttribute("data-sort-id");t.ui.sortOptions.find(e=>e.id===s)&&(e.currentSort=s,n.querySelectorAll(".sort-option").forEach(e=>{const t=e.getAttribute("data-sort-id")===s;e.classList.toggle("active",t),e.classList.toggle("bg-brand-200",t),e.classList.toggle("dark:bg-brand-dark/30",t),e.classList.toggle("text-brand-700",t),e.classList.toggle("dark:text-brand-dark",t),e.classList.toggle("font-medium",t),e.classList.toggle("text-neutral-600",!t),e.classList.toggle("font-normal",!t);const o=e.querySelector("svg");t&&!o?e.innerHTML+='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>':!t&&o&&o.remove()}),n.classList.add("hidden"),r())})):console.warn("Sort dropdown elements not found:",{sortButton:o,sortMenu:n})}();const o=document.querySelector("#results-panel .panel-content");o&&o.addEventListener("scroll",()=>{const{scrollTop:n,scrollHeight:r,clientHeight:i}=o;if(n+i>=r-200&&e.currentRenderCount<e.allFilteredNeighborhoods.length){const o=e.allFilteredNeighborhoods.slice(e.currentRenderCount,e.currentRenderCount+t.data.batchSize);o.length>0&&(renderListItems(o),e.currentRenderCount+=t.data.batchSize)}}),document.getElementById("sidebar").addEventListener("click",function(e){if(e.target.closest("button")||e.target.closest("a")||e.target.closest("label")||e.target.closest("input")||e.target.closest(".menu-item"))return;const t=document.getElementById("drawer-toggle");t&&t.checked&&(t.checked=!1)})}