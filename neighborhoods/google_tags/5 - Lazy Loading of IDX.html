<!-- GTM Custom HTML Tag: Add Lazy Loading to IDX Images (Enhanced with Retry Logic) -->
<script>
  console.log('Lazy loading script loaded (outside event)');

  // Function to apply lazy loading to IDX images
  function applyLazyLoading() {
    var images = document.querySelectorAll('.si-listing__photo-img img');
    
    if (images.length === 0) {
      console.log('No IDX images found yet with selector ".si-listing__photo-img img"');
      return false; // IDX not loaded yet
    }
    
    console.log('Found ' + images.length + ' IDX images to lazy-load');
    var processedCount = 0;
    
    for (var i = 0; i < images.length; i++) {
      var img = images[i];
      var originalSrc = img.getAttribute('data-src') || img.src;
      
      if (originalSrc && originalSrc.indexOf('loadingphoto_mid.gif') === -1) {
        if (!img.hasAttribute('loading')) {
          img.loading = 'lazy';
          processedCount++;
          console.log('Added lazy loading to IDX image:', originalSrc);
        }
      } else {
        console.log('Skipped placeholder image:', img.src);
      }
    }
    
    console.log('Successfully applied lazy loading to ' + processedCount + ' images');
    return true; // Success
  }

  // Retry logic for AJAX-loaded IDX content
  window.addEventListener('DOMContentLoaded', function() {
    console.log('Lazy loading script started (DOMContentLoaded fired)');
    
    // Try immediately first
    if (applyLazyLoading()) {
      console.log('IDX lazy loading complete on first attempt');
      return; // Early exit - no need for retry logic
    }
    
    // If not found, start retry logic
    var attempts = 1; // Already tried once
    var maxAttempts = 20; // Try for ~5 seconds
    
    var checkInterval = setInterval(function() {
      attempts++;
      
      if (applyLazyLoading()) {
        // Success - stop checking
        clearInterval(checkInterval);
        console.log('IDX lazy loading complete after ' + attempts + ' attempt(s)');
      } else if (attempts >= maxAttempts) {
        // Give up after max attempts
        clearInterval(checkInterval);
        console.log('IDX images not found after ' + maxAttempts + ' attempts - IDX may not be present on this page');
      }
    }, 250); // Check every 250ms
  });
</script>