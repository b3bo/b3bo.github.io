<!DOCTYPE html>
<!-- 
  index.html
  
  Main entry point for the Community Finder application. 
  Contains the Google Maps interface, sidebar navigation, filtering logic, 
  and neighborhood data display.

  restored
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="index, follow">
    <title>Emerald Coast Neighborhood FinderG�� | Interactive Tool for 30A Home Buyers</title>
    <meta name="description" content="Free interactive tool to help buyers compare and select the perfect 30A and Emerald Coast community. Filter neighborhoods by price, amenities, and location across Destin, Miramar Beach, and 30A.">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://neighborhoods.truesouthcoastalhomes.com/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://neighborhoods.truesouthcoastalhomes.com/">
    <meta property="og:title" content="Emerald Coast Neighborhood FinderG�� | Interactive Tool for 30A Home Buyers">
    <meta property="og:description" content="Free interactive tool to help buyers compare and select the perfect 30A and Emerald Coast community. Filter neighborhoods by price, amenities, and location across Destin, Miramar Beach, and 30A.">
    <meta property="og:image" content="https://neighborhoods.truesouthcoastalhomes.com/assets/img/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="True South Coastal Homes">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://neighborhoods.truesouthcoastalhomes.com/">
    <meta name="twitter:title" content="Emerald Coast Neighborhood FinderG�� | Interactive Tool for 30A Home Buyers">
    <meta name="twitter:description" content="Free interactive tool to help buyers compare and select the perfect 30A and Emerald Coast community. Filter neighborhoods by price, amenities, and location.">
    <meta name="twitter:image" content="https://neighborhoods.truesouthcoastalhomes.com/assets/img/og-image.jpg">

    <!-- Additional SEO Meta Tags -->
    <meta name="keywords" content="30A neighborhoods, Destin homes, Miramar Beach communities, Emerald Coast real estate, Florida beach communities, Watersound, Alys Beach, Rosemary Beach, Seaside Florida">
    <meta name="author" content="Kimberly Bauman, P.A. - True South Coastal Homes">
    <meta name="geo.region" content="US-FL">
    <meta name="geo.placename" content="Santa Rosa Beach, Florida">
    <meta name="geo.position" content="30.294396;-86.013175">
    <meta name="ICBM" content="30.294396, -86.013175">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="../neighborhoods/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../neighborhoods/img/favicon-16x16.png">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../neighborhoods/css/styles.css">
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="../neighborhoods/css/tailwind_neighborhoods.css">

    <!-- Google Maps API moved to end of body to prevent race condition -->
    
    <style>
        /* Prevent text selection to discourage copying */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Allow selection in inputs */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* Info window custom styles */
        .gm-style .info-window {
            font-family: var(--font-body);
        }
        
        /* Hide the default close button */
        .gm-style-iw-chr {
            display: none !important;
        }
        
        /* Remove padding/margin from the info window container */
        .gm-style .gm-style-iw-c {
            padding: 0 !important;
            border: none !important;
            /* Remove dark outline and minimize shadow */
            box-shadow: none !important;
            background-color: #fff !important;
            outline: none !important;
            border-radius: 12px !important;
        }
        
        /* Remove border/shadow from info window tip */
        .gm-style .gm-style-iw-tc::after {
            background: #fff !important;
            box-shadow: none !important;
            border: none !important;
        }

        /* Ensure content card has no outer outline */
        .gm-style .info-window {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            border-radius: 12px !important;
        }

        /* Remove default padding from internal content wrapper */
        .gm-style .gm-style-iw-d {
            padding: 0 !important;
            overflow: hidden !important;
        }
        
        /* Map container sizing - full screen */
        #map-layout {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Position map type control to the left of fullscreen button */
        .gm-style-mtc {
            transform: translateX(-20px) !important;
        }
        
        /* Mobile: move map/sat buttons further left to avoid overlap with fullscreen */
        @media (max-width: 767px) {
            .gm-style-mtc {
                transform: translateX(-55px) !important;
            }
        }

        /* Tab icon switching */
        #drawer-toggle:checked ~ aside .tab-icon-closed {
            display: none;
        }

        #drawer-toggle:checked ~ aside .tab-icon-open {
            display: block;
        }

        /* Ripple marker animation */
        @keyframes ripple-animation {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }
        
        /* Landscape mode on mobile devices */
        @media (max-height: 500px) and (orientation: landscape) {
            #sidebar {
                /* Keep floating card style. Do NOT change width at this height breakpoint
                   � changing the sidebar width here caused the Results sliding-panel to
                   shrink and introduce layout/scroll regressions on short viewports. */
                height: calc(100dvh - 2rem) !important;
                max-height: calc(100dvh - 2rem) !important;
                /* Maintain rounded corners */
                border-radius: 1rem !important;
                /* Keep flex layout */
                display: flex !important;
            }

            #sidebar-scroll-container {
                overflow-y: auto !important;
                height: 100% !important;
                width: 100% !important;
                display: block !important;
            }

            /* Disable internal scrolling for content */
            #sidebar-content {
                overflow: visible !important;
                height: auto !important;
                flex: none !important;
            }

            /* Compact spacing for landscape */
            #sidebar .p-5 {
                padding: 0.75rem 1rem !important;
            }

            #sidebar .pt-4 {
                padding-top: 0.5rem !important;
            }

            #sidebar .gap-6 {
                gap: 1rem !important;
            }

            #sidebar .pb-3 {
                padding-bottom: 0.5rem !important;
            }

            /* Short viewports: make sliding panels fixed overlays so they do not
               participate in document flow and therefore avoid double-scrollbar
               scenarios where both the document and the panel are independently scrollable. */
            .sliding-panel {
                position: fixed !important;
                inset: 0 !important; /* handle all sides (top,right,bottom,left) */
                width: 100% !important;
                height: 100% !important;
            }
        }


        /* Custom Scrollbar for Sidebar */
        #sidebar-content::-webkit-scrollbar,
        #sidebar-scroll-container::-webkit-scrollbar,
        #main-menu::-webkit-scrollbar,
        .panel-content::-webkit-scrollbar {
            width: 6px;
        }

        #sidebar-content::-webkit-scrollbar-track,
        #sidebar-scroll-container::-webkit-scrollbar-track,
        #main-menu::-webkit-scrollbar-track,
        .panel-content::-webkit-scrollbar-track {
            background: transparent;
        }

          /* Scrollbar thumb uses the brand colors to match button states.
              Desired mapping:
              - default (inactive): lighter brand (brand-100)
              - hover: same as default (brand-100)
              - active (pressed): darker brand (brand-200) � same as active buttons like Homes/Condos
              Dark mode uses translucent variants (20% default/hover, 30% active). */
        #sidebar-content::-webkit-scrollbar-thumb,
        #sidebar-scroll-container::-webkit-scrollbar-thumb,
        #main-menu::-webkit-scrollbar-thumb,
        .panel-content::-webkit-scrollbar-thumb {
                background-color: var(--color-brand-100);
            opacity: 1; /* previously active state used full opacity */
            border-radius: 20px;
            transition: background-color 180ms ease, opacity 180ms ease;
        }

        /* Light mode � hover should match the inactive/default color */
        #sidebar-content::-webkit-scrollbar-thumb:hover,
        #sidebar-scroll-container::-webkit-scrollbar-thumb:hover,
        #main-menu::-webkit-scrollbar-thumb:hover,
        .panel-content::-webkit-scrollbar-thumb:hover {
            background-color: var(--color-brand-100); /* hover uses the same as default */
            opacity: 0.9;
        }

        #sidebar-content::-webkit-scrollbar-thumb:active,
        #sidebar-scroll-container::-webkit-scrollbar-thumb:active,
        #main-menu::-webkit-scrollbar-thumb:active,
        .panel-content::-webkit-scrollbar-thumb:active {
                /* Active (pressed) uses the brand base token (matches active buttons)
                   Use explicit brand token to ensure value is available in this scope */
            background-color: var(--color-brand-base);
            opacity: 1;
        }

        /* Add small inner padding on Results panel so scrollbar doesn't sit tight against list items */
        #results-panel .panel-content {
            padding-right: 0.75rem; /* 12px � small visual buffer for the scrollbar */
        }

        /* Dark mode scrollbar � use brand RGB token for translucent variants */
        .dark #sidebar-content::-webkit-scrollbar-thumb,
        .dark #sidebar-scroll-container::-webkit-scrollbar-thumb,
        .dark #main-menu::-webkit-scrollbar-thumb,
        .dark .panel-content::-webkit-scrollbar-thumb {
            background-color: rgba(var(--color-brand-rgb), 0.20);
            opacity: 1;
        }

        .dark #sidebar-content::-webkit-scrollbar-thumb:hover,
        .dark #sidebar-scroll-container::-webkit-scrollbar-thumb:hover,
        .dark #main-menu::-webkit-scrollbar-thumb:hover,
        .dark .panel-content::-webkit-scrollbar-thumb:hover {
            background-color: rgba(var(--color-brand-rgb), 0.20);
            opacity: 1;
        }

        .dark #sidebar-content::-webkit-scrollbar-thumb:active,
        .dark #sidebar-scroll-container::-webkit-scrollbar-thumb:active,
        .dark #main-menu::-webkit-scrollbar-thumb:active,
        .dark .panel-content::-webkit-scrollbar-thumb:active {
            background-color: rgba(var(--color-brand-rgb), 0.30);
            opacity: 1;
        }

        /* Mobile faux fullscreen state */
        body.mobile-faux-fullscreen {
            overflow: hidden;
            background-color: #f5f5f4;
        }

        body.mobile-faux-fullscreen #map-layout {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1050;
            background-color: #f5f5f4;
        }

        body.mobile-faux-fullscreen #map {
            width: 100vw !important;
            height: 100vh !important;
        }

        body.mobile-faux-fullscreen #sidebar {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-120%) !important;
        }

        body.mobile-faux-fullscreen label[for="drawer-toggle"] {
            opacity: 0;
            pointer-events: none;
        }

        body.mobile-faux-fullscreen .mobile-fullscreen-btn {
            position: fixed !important;
            top: 1rem;
            right: 1rem;
            z-index: 1100;
            opacity: 0.9;
        }

        /* Ensure all sliding panels match the sidebar's inner width and
           use consistent box-sizing so padding does not change layout width. */
        .sliding-panel {
            box-sizing: border-box;
            width: 100%;
        }

          /* (reverted) panel-open toggling removed � previously attempted to prevent
              a double-scrollbar effect; this change has been undone. */

    </style>

    <!-- Schema.org Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Emerald Coast Neighborhood Finder",
        "description": "Interactive neighborhood search tool for Florida's Emerald Coast including 30A, Destin, and Miramar Beach communities",
        "url": "https://neighborhoods.truesouthcoastalhomes.com/",
        "applicationCategory": "Real Estate",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "provider": {
            "@type": "RealEstateAgent",
            "name": "Kimberly Bauman, P.A.",
            "brand": "True South Coastal Homes",
            "url": "https://truesouthcoastalhomes.com",
            "address": {
                "@type": "PostalAddress",
                "addressLocality": "Santa Rosa Beach",
                "addressRegion": "FL",
                "addressCountry": "US"
            },
            "areaServed": [
                {
                    "@type": "City",
                    "name": "Santa Rosa Beach",
                    "containedIn": {
                        "@type": "State",
                        "name": "Florida"
                    }
                },
                {
                    "@type": "City",
                    "name": "Destin",
                    "containedIn": {
                        "@type": "State",
                        "name": "Florida"
                    }
                },
                {
                    "@type": "City",
                    "name": "Miramar Beach",
                    "containedIn": {
                        "@type": "State",
                        "name": "Florida"
                    }
                }
            ]
        },
        "featureList": [
            "Interactive neighborhood maps",
            "Real-time pricing data",
            "Community amenities filtering",
            "Multiple property types (homes, condos, townhomes)",
            "Sortable search results",
            "Mobile-friendly interface"
        ],
        "geo": {
            "@type": "GeoCoordinates",
            "latitude": "30.294396",
            "longitude": "-86.013175"
        }
    }
    </script>
</head>
<body class="overflow-hidden font-body text-neutral-700 dark:bg-dark-bg-base dark:text-dark-text-primary h-dvh">
    <div class="flex flex-col h-dvh">
        <!-- Hidden checkbox controls drawer state -->
        <input type="checkbox" id="drawer-toggle" class="hidden peer" checked />

        <!-- Drawer Sidebar with attached tab -->
        <aside id="sidebar" class="fixed top-4 left-4 w-4/5 max-w-xs shadow-2xl rounded-2xl -translate-x-full transition-transform duration-[3000ms] z-40 flex flex-col bg-white dark:bg-dark-bg-elevated border border-neutral-200 dark:border-dark-border" style="height: calc(100dvh - 2rem); max-height: calc(100dvh - 2rem);">
            <!-- Keep sidebar height constant across breakpoints; removed md-specific height override so it won't shrink on larger viewports -->
            <!-- Tab attached to drawer edge -->
            <label for="drawer-toggle" class="absolute left-full top-1/2 -translate-y-1/2 bg-neutral-700 px-2 py-4 cursor-pointer shadow-lg hover:bg-neutral-800 transition-colors rounded-r-lg">
                <!-- Hamburger icon (shows when closed) -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="white" class="w-5 h-5 tab-icon-closed">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
                <!-- X icon (shows when open) -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="white" class="w-5 h-5 tab-icon-open hidden">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
            </label>

            <!-- Fixed Header Section -->
            <div class="flex-shrink-0 w-full overflow-x-hidden">
                <!-- Header -->
                <div>
                    <div class="p-5 pb-4 flex items-center gap-3">
                        <div class="w-10 h-10 bg-neutral-800 rounded-lg flex items-center justify-center shrink-0">
                            <span style="font-family: 'Cinzel', serif; font-size: 1.25rem; font-weight: 600; color: white; letter-spacing: 0.05em;">TS</span>
                        </div>
                        <div class="flex-1">
                            <h1 class="text-lg font-heading font-semibold text-neutral-700 dark:text-dark-text-primary">Neighborhood Finder&trade;</h1>
                            <p class="text-xs text-neutral-500 dark:text-dark-text-secondary">30A & Florida's Emerald Coast</p>
                        </div>
                    </div>

                    <div class="px-5">
                        <hr class="divider">
                        <p id="resultsCount" class="text-sm text-neutral-500 dark:text-dark-text-secondary font-medium text-center py-4"></p>
                        <hr class="divider">
                    </div>
                </div>
            </div>

            <div id="sidebar-scroll-container" class="flex-1 w-full overflow-hidden relative">
                <!-- Main Menu -->
                <div id="main-menu" class="pt-3 h-full overflow-y-auto overflow-x-hidden overscroll-contain px-5">
                    <div class="space-y-2">
                        <!-- Criteria Menu Item -->
                        <div class="flex items-center justify-between py-4 cursor-pointer transition-colors rounded-lg hover:bg-brand-100 dark:hover:bg-brand-dark/20 active:bg-brand-200 dark:active:bg-brand-dark/30 menu-item px-3" data-panel="property">
                            <span class="text-[0.9375rem] font-medium text-neutral-700 dark:text-dark-text-primary">Criteria</span>
                            <svg class="w-5 h-5 text-neutral-500 dark:text-dark-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </div>

                        <!-- Areas Menu Item -->
                        <div class="flex items-center justify-between py-4 cursor-pointer transition-colors rounded-lg hover:bg-brand-100 dark:hover:bg-brand-dark/20 active:bg-brand-200 dark:active:bg-brand-dark/30 menu-item px-3" data-panel="areas">
                            <span class="text-[0.9375rem] font-medium text-neutral-700 dark:text-dark-text-primary">Areas</span>
                            <svg class="w-5 h-5 text-neutral-500 dark:text-dark-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </div>

                        <!-- Amenities Menu Item -->
                        <div class="flex items-center justify-between py-4 cursor-pointer transition-colors rounded-lg hover:bg-brand-100 dark:hover:bg-brand-dark/20 active:bg-brand-200 dark:active:bg-brand-dark/30 menu-item px-3" data-panel="amenities">
                            <span class="text-[0.9375rem] font-medium text-neutral-700 dark:text-dark-text-primary">Amenities</span>
                            <svg class="w-5 h-5 text-neutral-500 dark:text-dark-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </div>

                        <!-- Results Menu Item / Community Finder Link -->
                        <div id="results-menu-item" class="flex items-center justify-between py-4 cursor-pointer transition-colors rounded-lg hover:bg-brand-100 dark:hover:bg-brand-dark/20 active:bg-brand-200 dark:active:bg-brand-dark/30 menu-item px-3" data-panel="results">
                            <span class="text-[0.9375rem] font-medium text-neutral-700 dark:text-dark-text-primary">Results</span>
                            <svg class="w-5 h-5 text-neutral-500 dark:text-dark-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </div>

                        <!-- Theme Toggle -->
                        <button id="theme-toggle" class="w-full flex items-center justify-between py-4 cursor-pointer transition-colors rounded-lg hover:bg-brand-100 dark:hover:bg-brand-dark/20 active:bg-brand-200 dark:active:bg-brand-dark/30 px-3">
                            <span class="text-[0.9375rem] font-medium text-neutral-700 dark:text-dark-text-primary">Theme</span>
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-brand-500 dark:text-brand-dark theme-icon-light" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                                <svg class="w-5 h-5 text-brand-500 dark:text-brand-dark theme-icon-dark hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                                </svg>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Property Panel -->
                <div id="property-panel" class="absolute top-0 left-0 w-full h-full bg-white dark:bg-dark-bg-elevated translate-x-full transition-transform duration-[3000ms] ease-out z-10 flex flex-col rounded-2xl overflow-hidden will-change-transform px-5 box-border sliding-panel">
                    <div class="flex items-center flex-shrink-0 py-3">
                        <button class="flex w-full items-center justify-start gap-2 bg-transparent border-0 text-neutral-700 dark:text-dark-text-primary text-[0.9375rem] font-semibold cursor-pointer rounded-lg transition-colors hover:bg-brand-100 dark:hover:bg-brand-dark/20 active:bg-brand-200 dark:active:bg-brand-dark/30 panel-back-btn text-left py-4 px-3" data-close-panel="property">
                            <svg class="w-5 h-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                            <span>Criteria</span>
                        </button>
                    </div>
                    <hr class="divider mx-4 pb-4">
                    <div class="flex-1 overflow-y-auto overflow-x-hidden overscroll-contain -webkit-overflow-scrolling-touch panel-content py-4">
                        <!-- Toggle Buttons -->
                        <div class="flex gap-2 pb-6 px-3">
                            <button id="btn-homes" class="flex-1 inline-flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium border border-neutral-300 dark:border-dark-border bg-white dark:bg-dark-bg-elevated text-neutral-700 dark:text-dark-text-primary hover:bg-brand-100 dark:hover:bg-brand-dark/20 hover:text-brand-700 dark:hover:text-brand-dark transition-colors cursor-pointer">
                                Homes
                            </button>
                            <button id="btn-condos" class="flex-1 inline-flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium border border-neutral-300 dark:border-dark-border bg-white dark:bg-dark-bg-elevated text-neutral-700 dark:text-dark-text-primary hover:bg-brand-100 dark:hover:bg-brand-dark/20 hover:text-brand-700 dark:hover:text-brand-dark transition-colors cursor-pointer">
                                Condos
                            </button>
                        </div>
                        <hr class="divider mx-4 mb-3">

                        <div class="space-y-6 px-3">
                            <!-- Price Range Slider -->
                            <div>
                                <div class="flex justify-between items-baseline mb-1">
                                    <span class="text-xs font-medium text-neutral-500 dark:text-dark-text-secondary">Price</span>
                                    <span class="text-sm font-semibold text-neutral-700 dark:text-dark-text-primary" id="price-display">$250K - $35M+</span>
                                </div>
                                <div class="range-slider">
                                    <div class="range-track-bg"></div>
                                    <div class="range-track-fill" id="price-fill"></div>
                                    <input type="range" min="0" max="41" value="0" id="price-min">
                                    <input type="range" min="0" max="41" value="0" id="price-max">
                                </div>
                            </div>

                            <!-- Beds Slider -->
                            <div>
                                <div class="flex justify-between items-baseline mb-1">
                                    <span class="text-xs font-medium text-neutral-500 dark:text-dark-text-secondary">Beds</span>
                                    <span class="text-sm font-semibold text-neutral-700 dark:text-dark-text-primary" id="beds-display">1+</span>
                                </div>
                                <div class="range-slider">
                                    <div class="range-track-bg"></div>
                                    <div class="range-track-fill" id="beds-fill" style="width: 0%;"></div>
                                    <input type="range" min="1" max="6" value="1" step="1" id="beds-min">
                                </div>
                            </div>

                            <!-- Baths Slider -->
                            <div>
                                <div class="flex justify-between items-baseline mb-1">
                                    <span class="text-xs font-medium text-neutral-500 dark:text-dark-text-secondary">Baths</span>
                                    <span class="text-sm font-semibold text-neutral-700 dark:text-dark-text-primary" id="baths-display">1+</span>
                                </div>
                                <div class="range-slider">
                                    <div class="range-track-bg"></div>
                                    <div class="range-track-fill" id="baths-fill" style="width: 0%;"></div>
                                    <input type="range" min="1" max="6" value="1" step="1" id="baths-min">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Areas Panel -->
                <div id="areas-panel" class="absolute top-0 left-0 w-full h-full bg-white dark:bg-dark-bg-elevated translate-x-full transition-transform duration-[3000ms] ease-out z-10 flex flex-col rounded-2xl overflow-hidden will-change-transform px-5 box-border sliding-panel">
                    <div class="flex items-center flex-shrink-0 py-3">
                        <button class="flex w-full items-center justify-start gap-2 bg-transparent border-0 text-neutral-700 dark:text-dark-text-primary text-[0.9375rem] font-semibold cursor-pointer rounded-lg transition-colors hover:bg-brand-100 dark:hover:bg-brand-dark/20 active:bg-brand-200 dark:active:bg-brand-dark/30 panel-back-btn text-left py-4 px-3" data-close-panel="areas">
                            <svg class="w-5 h-5 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                            <span>Areas</span>
                        </button>
                    </div>
                    <hr class="divider mx-4 pb-4">
                    <div class="flex-1 overflow-y-auto overflow-x-hidden overscroll-contain -webkit-overflow-scrolling-touch panel-content">
                        <div class="flex flex-wrap gap-2" id="areaFilters">
                            <button class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium border border-neutral-300 dark:border-dark-border bg-white dark:bg-dark-bg-elevated text-neutral-700 dark:text-dark-text-primary hover:bg-brand-100 dark:hover:bg-brand-dark/20 hover:text-brand-700 dark:hover:text-brand-dark transition-colors cursor-pointer amenity-tag" data-zipcode="32541">Destin</button>
                            <button class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium border border-neutral-300 dark:border-dark-border bg-white dark:bg-dark-bg-elevated text-neutral-700 dark:text-dark-text-primary hover:bg-brand-100 dark:hover:bg-brand-dark/20 hover:text-brand-700 dark:hover:text-brand-dark transition-colors cursor-pointer amenity-tag" data-zipcode="32459">Santa Rosa Beach</button>
                            <button class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium border border-neutral-300 dark:border-dark-border bg-white dark:bg-dark-bg-elevated text-neutral-700 dark:text-dark-text-primary hover:bg-brand-100 dark:hover:bg-brand-dark/20 hover:text-brand-700 dark:hover:text-brand-dark transition-colors cursor-pointer amenity-tag" data-zipcode="32550">Miramar Beach</button>
                            <button class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium border border-neutral-300 dark:border-dark-border bg-white dark:bg-dark-bg-elevated text-neutral-700 dark:text-dark-text-primary hover:bg-brand-100 dark:hover:bg-brand-dark/20 hover:text-brand-700 dark:hover:text-brand-dark transition-colors cursor-pointer amenity-tag" data-zipcode="32461">Inlet Beach</button>
                            <button class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium border border-neutral-300 dark:border-dark-border bg-white dark:bg-dark-bg-elevated text-neutral-700 dark:text-dark-text-primary hover:bg-brand-100 dark:hover:bg-brand-dark/20 hover:text-brand-700 dark:hover:text-brand-dark transition-colors cursor-pointer amenity-tag" data-zipcode="32413">Panama City Beach</button>
                        </div>
                    </div>
                </div>

                <!-- Amenities Panel -->
                <div id="amenities-panel" class="absolute top-0 left-0 w-full h-full bg-white dark:bg-dark-bg-elevated translate-x-full transition-transform duration-[3000ms] ease-out z-10 flex flex-col rounded-2xl overflow-hidden will-change-transform px-5 box-border sliding-panel">
                    <div class="flex items-center flex-shrink-0 py-3">
                        <button class="flex w-full items-center justify-start gap-2 bg-transparent border-0 text-neutral-700 dark:text-dark-text-primary text-[0.9375rem] font-semibold cursor-pointer rounded-lg transition-colors hover:bg-brand-100 dark:hover:bg-brand-dark/20 active:bg-brand-200 dark:active:bg-brand-dark/30 panel-back-btn text-left py-4 px-3" data-close-panel="amenities">
                            <svg class="w-5 h-5 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                            <span>Amenities</span>
                        </button>
                    </div>
                    <hr class="divider mx-4 pb-4">
                    <div class="flex-1 overflow-y-auto overflow-x-hidden overscroll-contain -webkit-overflow-scrolling-touch panel-content">
                        <div class="flex flex-wrap gap-2" id="amenityFilters">
                            <!-- Tags will be dynamically generated -->
                        </div>
                    </div>
                </div>

                <!-- Results Panel -->
                <div id="results-panel" class="absolute top-0 left-0 w-full h-full bg-white dark:bg-dark-bg-elevated translate-x-full transition-transform duration-[3000ms] ease-out z-10 flex flex-col rounded-2xl overflow-hidden will-change-transform px-5 box-border sliding-panel">
                    <div class="flex items-center justify-between py-4 flex-shrink-0">
                        <button class="flex flex-1 items-center justify-start gap-2 bg-transparent border-0 text-neutral-700 dark:text-dark-text-primary text-[0.9375rem] font-semibold cursor-pointer rounded-lg transition-colors hover:bg-brand-100 dark:hover:bg-brand-dark/20 active:bg-brand-200 dark:active:bg-brand-dark/30 panel-back-btn text-left py-4 pl-4 pr-6 mr-4 relative z-10" data-close-panel="results">
                            <svg class="w-5 h-5 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                            <span>Results</span>
                        </button>
                        <div class="flex items-center gap-2 relative overflow-visible">
                            <div class="filter-container relative">
                                <button id="sort-button" class="sort-button flex items-center justify-center w-[65px] h-[65px] p-3 rounded-lg border border-neutral-300 dark:border-dark-border bg-white dark:bg-dark-bg-elevated hover:bg-brand-100 dark:hover:bg-brand-dark/20 hover:text-brand-700 dark:hover:text-brand-dark active:bg-brand-200 dark:active:bg-brand-dark/30 transition-colors" aria-label="Sort options">
                                    <!-- Up/Down arrow icon (compact image-like SVG) -->
                                    <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" class="text-neutral-800 dark:text-dark-text-primary">
                                        <!-- Up triangle -->
                                        <polygon points="10,3 6,8 14,8" fill="currentColor" />
                                        <!-- Down triangle -->
                                        <polygon points="10,17 6,12 14,12" fill="currentColor" />
                                    </svg>
                                </button>
                                                                <!--
                                                                        Developer note:
                                                                        - Outer container padding is applied here (p-6). This controls the space around the option rows.
                                                                        - Do NOT change `.sort-option` row padding (py-2) if you want to preserve vertical spacing between items.
                                                                        - Horizontal/vertical fine offsets for the portal are configured in `assets/js/config.js` as
                                                                            `CONFIG.ui.sortMenuOffset` (x/y per-breakpoint). Adjust offsets there, not here.
                                                                -->
                                                                <div id="sort-menu" class="sort-menu hidden bg-white dark:bg-dark-bg-elevated rounded-lg shadow-lg border border-neutral-200 dark:border-dark-border p-6 origin-top-left text-left" style="max-width: calc(80vw); z-index: 9999;">
                                    <!-- Options dynamically generated by ui.js -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr class="divider mx-4 pb-4">
                    <div class="flex-1 overflow-y-auto overflow-x-hidden overscroll-contain -webkit-overflow-scrolling-touch panel-content">
                        <div id="neighborhoodList" class="space-y-2">
                            <!-- List items will be dynamically generated -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Version info at bottom of sidebar -->
            <div class="flex-shrink-0 w-full">
                <div class="px-5">
                    <hr class="divider">
                    <p class="text-xs text-neutral-400 dark:text-neutral-600 text-center py-2">Version 1.0.1 | <span id="refreshDate">Refresh Dt: 12.06.25</span></p>
                </div>
            </div>
        </aside>

        <!-- Main content area with map and sidebar -->
        <div id="map-layout" class="flex flex-1 relative md:flex-row overflow-hidden">
            <!-- Map -->
            <div id="map" class="flex-1 bg-neutral-100 relative">
                <!-- Loading Screen -->
                <div id="loading-screen" class="absolute inset-0 bg-neutral-100 flex items-center justify-center z-20">
                    <div class="text-center">
                        <div class="w-12 h-12 border-4 border-neutral-300 border-t-neutral-700 rounded-full animate-spin mx-auto"></div>
                        <p class="text-neutral-600 font-medium">Loading Community Finder...</p>
                    </div>
                </div>
            </div>

            <!-- Backdrop overlay -->
            <label for="drawer-toggle" id="sidebar-backdrop" class="fixed inset-0 bg-black/50 opacity-0 pointer-events-none peer-checked:opacity-100 peer-checked:pointer-events-auto transition-opacity z-30"></label>
        </div>
        
        <!-- Disclaimer (hidden on single neighborhood embeds) -->
        <div id="map-disclaimer" class="border-t border-neutral-200 dark:border-dark-border px-4 py-3 text-center bg-white/70 dark:bg-dark-bg-elevated/70 backdrop-blur-md">
            <p class="text-xs text-neutral-500 leading-relaxed">
                -� <span id="currentYear">2025</span> Kimberly Bauman, P.A. |  All Rights Reserved | All information provided is deemed reliable but is not guaranteed and should be independently verified. Property data sourced from ECAR MLS.
            </p>
        </div>
    </div>

    <script>
        // Shim to handle Google Maps callback before module loads
        window.initMap = function() {
            window.googleMapsReady = true;
        };
    </script>
    <script>
        // Short refresh date display (keeps the footer compact)
        (function() {
            const refreshEl = document.getElementById('refreshDate');
            if (!refreshEl) return;
            // Use a short, fixed refresh string to avoid locale/formatting issues.
            refreshEl.textContent = 'Refresh Dt: 12.06.25';
        })();
    </script>
    
    <script>
        // script initialized
        // Sliding panel navigation
        document.addEventListener('DOMContentLoaded', function() {
            // sliding panels initializing
            // Get all menu items
            const menuItems = document.querySelectorAll('.menu-item');
            const backButtons = document.querySelectorAll('.panel-back-btn');
            const mainMenu = document.getElementById('main-menu');

            // menu items/back buttons counts available

            // Handle menu item clicks via delegated listener so we catch dynamically
            // created items or different DOM structures (helps if main-menu is missing
            // or elements are added after initialization). We look for an element with
            // `data-panel` or the `menu-item` class and use closest() to find it.
            document.addEventListener('click', function (e) {
                // Try to locate the most likely menu candidate. Prefer explicit
                // menu-item/data-panel nodes, but fall back to anchors, buttons,
                // or other likely nav elements so embedded DOMs are handled.
                let clicked = e.target.closest('[data-panel], .menu-item');
                if (!clicked) {
                    clicked = e.target.closest('a, button, [data-target], [aria-controls], [role="menuitem"], [role="link"], [class*="menu"], [class*="nav"]');
                }
                if (!clicked) return; // not something we can reasonably map

                // Prefer explicit data-panel attribute, but fall back to dataset
                // for different DOM shapes. As a last resort (some embedded /
                // single-mode pages remove the menu DOM entirely) try to match
                // the clicked element's text to a known label so clicks still
                // open the intended panel (Criteria, Areas, Amenities, Results).
                let panelName = clicked.getAttribute('data-panel') || (clicked.dataset && clicked.dataset.panel);

                if (!panelName) {
                    const text = (clicked.innerText || clicked.textContent || '').trim().split('\n')[0].toLowerCase();

                    if (text) {
                        // Try simple, forgiving patterns for common labels.
                        if (/criteria|property|filters?|search/i.test(text)) panelName = 'property';
                        else if (/area|neighborhood|regions?|city|zip/i.test(text)) panelName = 'areas';
                        else if (/amenit|feature|pool|parking|facility/i.test(text)) panelName = 'amenities';
                        else if (/result|results|map/i.test(text)) panelName = 'results';

                        // matched label fallback
                    }
                }

                // If still nothing, try deeper heuristics: href fragment (#results),
                // data-target/data-close attributes, aria-controls, title/aria-label,
                // or class-name hints. This helps when the original menu DOM is
                // replaced by simplified anchors or other elements in an embed.
                if (!panelName) {
                    // Check href fragment on anchors
                    try {
                        const href = clicked.getAttribute && clicked.getAttribute('href');
                        if (href && href.indexOf('#') !== -1) {
                            const frag = href.split('#').pop().toLowerCase();
                            if (/^results?$/.test(frag) || frag.includes('map')) panelName = 'results';
                            else if (/amenit/.test(frag)) panelName = 'amenities';
                            else if (/area|neigh|neighb|region|city|zip/.test(frag)) panelName = 'areas';
                            else if (/criteria|property|filter/.test(frag)) panelName = 'property';

                            // matched href fragment fallback
                        }
                    } catch (err) {
                        /* ignore attribute access failures in some embed contexts */
                    }

                    // data-target or aria-controls
                    if (!panelName) {
                        const dt = clicked.getAttribute && (clicked.getAttribute('data-target') || clicked.getAttribute('data-close') || clicked.getAttribute('data-close-panel'));
                        const ac = clicked.getAttribute && clicked.getAttribute('aria-controls');
                        const title = clicked.getAttribute && (clicked.getAttribute('title') || clicked.getAttribute('aria-label'));

                        const candidateText = (dt || ac || title || '').toLowerCase();
                        if (candidateText) {
                            if (/result|map/.test(candidateText)) panelName = 'results';
                            else if (/amenit|amenities|feature|pool|parking/.test(candidateText)) panelName = 'amenities';
                            else if (/area|neigh|region|city|zip/.test(candidateText)) panelName = 'areas';
                            else if (/criteri|property|filter/.test(candidateText)) panelName = 'property';

                            // matched attribute fallback
                        }
                    }

                    // Finally attempt to match the element's text or class name as a last resort
                    if (!panelName) {
                        const txt = (clicked.innerText || clicked.textContent || '').trim().split('\n')[0].toLowerCase();
                        const cls = (clicked.className || '').toLowerCase();
                        if (txt) {
                            if (/result|results|map/.test(txt)) panelName = 'results';
                            else if (/amenit|amenities|feature|pool|parking/.test(txt)) panelName = 'amenities';
                            else if (/area|neigh|region|city|zip/.test(txt)) panelName = 'areas';
                            else if (/criteria|property|filter/.test(txt)) panelName = 'property';
                        }
                        if (!panelName && cls) {
                            if (cls.indexOf('result') !== -1) panelName = 'results';
                            else if (cls.indexOf('amenit') !== -1) panelName = 'amenities';
                            else if (cls.indexOf('area') !== -1 || cls.indexOf('neigh') !== -1) panelName = 'areas';
                            else if (cls.indexOf('filter') !== -1 || cls.indexOf('criteria') !== -1) panelName = 'property';
                        }

                        // matched deep fallback
                    }
                }

                if (!panelName) return; // still nothing useful

                // menu item clicked (delegated): %s
                const panel = document.getElementById(panelName + '-panel');

                    if (panel) {
                        // panel found
                        
                        // Close all other panels first using class-based toggles. This
                        // avoids inline transform state conflicts and prevents visual
                        // flicker when panels open/close.
                        const allPanels = document.querySelectorAll('.sliding-panel');
                        allPanels.forEach(p => {
                            if (p.id !== panel.id) {
                                p.classList.add('translate-x-full');
                                // Clear any inline transform to avoid conflicting styles
                                // left over from earlier interactions.
                                p.style.transform = '';
                            }
                        });
                        
                        // Reset panel scroll position before opening
                        const panelContent = panel.querySelector('.panel-content');
                        if (panelContent) {
                            panelContent.scrollTop = 0;
                        }

                        // Hide main menu
                        if (mainMenu) mainMenu.style.display = 'none';
                        
                        // Slide the panel in by removing the off-screen class.
                        // Tailwind's transition-transform will animate this change.
                        panel.classList.remove('translate-x-full');
                        // panel transform updated
                        try { if (typeof notifyHost === 'function') notifyHost('opened', panelName); } catch (err) {}
                    } else {
                        // panel not found for panelName
                    }
                }, false);

            // Expose a public helper to open panels programmatically (used by
            // iframe hosts via postMessage). Keep it inside DOMContentLoaded so
            // it can close over `mainMenu` and other local state.
            function openSlidingPanel(panelName) {
                if (!panelName) return null;
                const panel = document.getElementById(panelName + '-panel');
                if (!panel) return null;

                // Close other panels
                const allPanels = document.querySelectorAll('.sliding-panel');
                allPanels.forEach(p => {
                    if (p.id !== panel.id) {
                        p.classList.add('translate-x-full');
                        p.style.transform = '';
                    }
                });

                // Reset scroll position
                const panelContent = panel.querySelector('.panel-content');
                if (panelContent) panelContent.scrollTop = 0;

                // Hide main menu (if present) to avoid double UI
                if (mainMenu) mainMenu.style.display = 'none';

                // Show requested panel
                panel.classList.remove('translate-x-full');
                return panel;
            }

            // Make helper available to `window` so it can be invoked by host
            // scripts or other debugging utilities. We attach it here (after
            // DOM is ready) to avoid exposing uninitialized state.
            // Small helper to notify parent/host about panel open/close events
            function notifyHost(action, panel) {
                try {
                    if (window.parent && window.parent !== window && window.parent.postMessage) {
                        window.parent.postMessage({ type: 'embeddedPanel', action: action, panel: panel }, '*');
                    }
                } catch (err) {
                    // ignore failures in cross-origin contexts
                }
            }

            const _openSlidingPanel = openSlidingPanel;
            window.openSlidingPanel = function(panelName) {
                const p = _openSlidingPanel(panelName);
                if (p) notifyHost('opened', panelName);
                return p;
            };

            // Listen for postMessage commands from a host page (embedding
            // document). This allows resilient cross-origin communication for
            // embed scenarios where menu clicks live outside the iframe.
            window.addEventListener('message', function (ev) {
                try {
                    const data = ev && ev.data;
                    if (!data || typeof data !== 'object') return;

                    if (data.type === 'openPanel' && data.panel) {
                        openSlidingPanel(String(data.panel));
                    } else if (data.type === 'closePanel' && data.panel) {
                        const p = document.getElementById(String(data.panel) + '-panel');
                        if (p) p.classList.add('translate-x-full');
                    } else if (data.type === 'closeAllPanels') {
                        document.querySelectorAll('.sliding-panel').forEach(p => p.classList.add('translate-x-full'));
                        if (mainMenu) mainMenu.style.removeProperty('display');
                    }
                } catch (err) {
                    console.warn('postMessage handler error', err);
                }
            });

            // Backwards compatibility: support messages sent as simple strings
            // 'open:results' or 'close:results' from older integration code.
            window.addEventListener('message', function (ev) {
                const d = ev && ev.data;
                if (!d || typeof d !== 'string') return;
                if (d.indexOf('open:') === 0) openSlidingPanel(d.split(':')[1]);
                if (d.indexOf('close:') === 0) {
                    const p = document.getElementById(d.split(':')[1] + '-panel');
                    if (p) p.classList.add('translate-x-full');
                }
            });

            // --- Additional in-page triggers & debug helpers -----------------
            // These help when the outer host can't be modified: listen for
            // hash/query triggers and provide keyboard shortcuts and a
            // developer debug overlay (enabled via ?panelDebug=1).

            function normalizePanelName(s) {
                if (!s) return null;
                const v = String(s).trim().toLowerCase();
                if (!v) return null;
                if (/^results?$/.test(v) || v.indexOf('map') !== -1) return 'results';
                if (/amenit/.test(v) || v.indexOf('amenities') !== -1) return 'amenities';
                if (/area|neigh|region|city|zip/.test(v)) return 'areas';
                if (/criteria|property|filter/.test(v) || v.indexOf('property') !== -1) return 'property';
                return null;
            }

            function openPanelFromLocation() {
                try {
                    const ps = new URLSearchParams(window.location.search || '');
                    const qPanel = ps.get('panel') || ps.get('open') || ps.get('show');
                    if (qPanel) {
                        const p = normalizePanelName(qPanel);
                        if (p) { window.openSlidingPanel(p); return; }
                    }

                    const hash = (window.location.hash || '').replace('#', '');
                    if (hash) {
                        // support various styles: open=results or open-results or results
                        const parts = hash.split(/[=:\-]/);
                        const maybe = parts.length > 1 ? parts[1] : parts[0];
                        const p = normalizePanelName(maybe || hash);
                        if (p) window.openSlidingPanel(p);
                    }
                } catch (err) {
                    /* ignore */
                }
            }

            // Run a first pass from current URL
            openPanelFromLocation();

            // Watch for changes to hash or history so hosts that change the
            // fragment still trigger panel opens.
            window.addEventListener('hashchange', openPanelFromLocation);
            window.addEventListener('popstate', openPanelFromLocation);

            // Keyboard shortcuts � only when user holds CTRL+ALT to avoid
            // accidental triggers. Map: P (property/criteria), A (areas), M (amenities), R (results)
            document.addEventListener('keydown', function (e) {
                if (!(e.ctrlKey && e.altKey)) return;
                const k = (e.key || '').toLowerCase();
                if (k === 'p') window.openSlidingPanel('property');
                if (k === 'a') window.openSlidingPanel('areas');
                if (k === 'm') window.openSlidingPanel('amenities');
                if (k === 'r') window.openSlidingPanel('results');
            });

            // debug overlay removed

            // For debug/diagnostic use, respond to simple ping messages so a
            // host can confirm the embedded frame is listening.
            window.addEventListener('message', function (ev) {
                const d = ev && ev.data;
                if (d && d === 'ping-embedded-panel') {
                    ev.source && ev.source.postMessage && ev.source.postMessage({ type: 'pong-embedded-panel', ready: true }, '*');
                }
            });

            
            // Handle back button clicks
            backButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent event bubbling
                    const panelName = this.getAttribute('data-close-panel');
                    const panel = document.getElementById(panelName + '-panel');

                    if (panel) {
                        // Close the panel by adding the off-screen class; CSS will
                        // perform the animation via transition-transform.
                        panel.classList.add('translate-x-full');
                        try { if (typeof notifyHost === 'function') notifyHost('closed', panelName); } catch (err) {}

                        // Show main menu immediately since we're closing the panel
                        // Restore the sidebar/main menu display in case it was hidden
                        // earlier (e.g., single/iframe mode set display:none !important).
                        const sidebar = document.getElementById('sidebar');
                        if (sidebar) {
                            // Remove any inline display property left over (including !important)
                            sidebar.style.removeProperty('display');
                        }
                        if (mainMenu) {
                            mainMenu.style.removeProperty('display');
                            mainMenu.scrollTop = 0;
                        }
                    }
                });
            });
        });

        // Portalled sort menu: move #sort-menu to document.body and position it as fixed
        (function() {
            function initSortMenuPortal() {
                const sortButton = document.getElementById('sort-button');
                const sortMenu = document.getElementById('sort-menu');
                if (!sortButton || !sortMenu) return;

                // Move the menu to the document body so it's not clipped by ancestor overflow
                document.body.appendChild(sortMenu);
                // Mark the menu as portal-controlled so other scripts (ui.js) don't add duplicate toggles
                sortMenu.dataset.portal = 'true';

                // Ensure it uses fixed positioning and neutral transform so JS controls placement
                sortMenu.style.position = 'fixed';
                sortMenu.style.transform = 'none';
                sortMenu.style.willChange = 'top,left';
                // Ensure measurements include padding/border when we compute width
                sortMenu.style.boxSizing = 'border-box';
                sortMenu.style.maxHeight = '60vh';
                sortMenu.style.overflow = 'auto';

                // Named fallback used when measurements fail for any reason
                const FALLBACK_MENU_WIDTH = 224;

                function positionMenu() {
                    const rect = sortButton.getBoundingClientRect();

                    // Ensure menu is visible when measuring (but invisible to user) so measurements are correct
                    const wasHidden = sortMenu.classList.contains('hidden');
                    if (wasHidden) {
                        sortMenu.classList.remove('hidden');
                        sortMenu.style.visibility = 'hidden';
                        // Force reflow so measurements are accurate
                        // eslint-disable-next-line no-unused-expressions
                        sortMenu.getBoundingClientRect();
                    }

                    // Prefer getBoundingClientRect() for subpixel-accurate measurements
                    let menuWidth = Math.round(sortMenu.getBoundingClientRect().width) || sortMenu.offsetWidth || (Number(getComputedStyle(sortMenu).width.replace('px','')) || FALLBACK_MENU_WIDTH);

                        // Anchor the menu's TOP-RIGHT to the button's BOTTOM-RIGHT and use small
                        // per-breakpoint offsets to control fine positioning.

                    // Default offsets (structured: x = horizontal, y = vertical)
                    const defaultOffsets = {
                        x: { desktop: 0, tablet: 0, mobile: 0 },
                        y: { desktop: 8, tablet: 8, mobile: 6 }
                    };

                    // Prefer config from window.CONFIG if available. Support both legacy numeric
                    // values and the new structured { x:{}, y:{} } format.
                    let cfgOffsets = defaultOffsets;
                    if (window.CONFIG && window.CONFIG.ui && window.CONFIG.ui.sortMenuOffset) {
                        const s = window.CONFIG.ui.sortMenuOffset;
                        if (typeof s === 'number') {
                            cfgOffsets = { x: { desktop: s, tablet: s, mobile: s }, y: defaultOffsets.y };
                        } else if (s && typeof s === 'object') {
                            cfgOffsets = {
                                x: Object.assign({}, defaultOffsets.x, s.x || {}),
                                y: Object.assign({}, defaultOffsets.y, s.y || {})
                            };
                        }
                    }

                    // Pick per-breakpoint values
                    const viewport = window.innerWidth;
                    const key = viewport < 640 ? 'mobile' : (viewport < 1024 ? 'tablet' : 'desktop');
                    const offsetX = Number(cfgOffsets.x[key] ?? cfgOffsets.x.desktop ?? 0);
                    const offsetY = Number(cfgOffsets.y[key] ?? cfgOffsets.y.desktop ?? 0);

                    // Compute final top/left anchored to the button bottom-right
                    const top = Math.round(rect.bottom + offsetY);
                    let left = Math.round(rect.right - menuWidth + offsetX);

                    // Keep menu inside viewport horizontally
                    left = Math.max(6, Math.min(left, window.innerWidth - menuWidth - 6));

                    // Apply positioning
                    sortMenu.style.top = top + 'px';
                    sortMenu.style.left = left + 'px';

                    // Ensure menu is above everything and visible (force very high z-index)
                    sortMenu.style.zIndex = '2147483647';
                    sortMenu.style.pointerEvents = 'auto';

                    // Restore visibility if we temporarily hid it
                    if (wasHidden) {
                        sortMenu.style.visibility = '';
                        sortMenu.classList.add('hidden');
                    }
                }

                // Toggle menu visibility and position when button is clicked
                sortButton.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const wasHidden = sortMenu.classList.contains('hidden');

                    // If we're opening the menu, ensure layout classes are present so measurements are correct.
                    // We add the grid classes at runtime to avoid editor lint warnings about redundant classes in HTML.
                    if (wasHidden) {
                        sortMenu.classList.add('grid', 'grid-cols-1', 'sm:grid-cols-2', 'gap-2');
                    }

                    // Toggle visibility
                    sortMenu.classList.toggle('hidden');

                    // If it was hidden and now we opened it, position after a frame to ensure CSS applied
                    if (wasHidden) {
                        requestAnimationFrame(() => {
                            positionMenu();
                        });
                    }
                });

                // Hide menu when clicking outside
                document.addEventListener('click', function (e) {
                    if (!sortMenu.classList.contains('hidden') && !sortMenu.contains(e.target) && e.target !== sortButton) {
                        // force hide and remove inline positioning after closing
                        sortMenu.classList.add('hidden');
                        sortMenu.style.top = '';
                        sortMenu.style.left = '';
                        sortMenu.style.zIndex = '';
                    }
                });

                // Reposition on resize/scroll so it follows the button
                ['resize', 'orientationchange'].forEach(evt => window.addEventListener(evt, () => {
                    if (!sortMenu.classList.contains('hidden')) positionMenu();
                }));

                // Reposition when container scrolls (capture) and also observe DOM changes in case the panel animates
                window.addEventListener('scroll', () => {
                    if (!sortMenu.classList.contains('hidden')) positionMenu();
                }, true);

                // If the results panel animates or resizes, keep menu aligned using a MutationObserver
                const resultsPanel = document.getElementById('results-panel');
                if (resultsPanel) {
                    const mo = new MutationObserver(() => {
                        if (!sortMenu.classList.contains('hidden')) positionMenu();
                    });
                    mo.observe(resultsPanel, { attributes: true, attributeFilter: ['style', 'class'], subtree: false });
                }
            }

            // Wait a tick to ensure DOM elements are present
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initSortMenuPortal);
            } else {
                initSortMenuPortal();
            }
        })();
        
        // Floating menu removed � keep page clean for testing (debug removed)
    </script>

    <script type="module" src="../neighborhoods/js/theme.js"></script>
    <script type="module">
        // Theme toggle click handler
        import { ThemeManager } from '../neighborhoods/js/theme.js';

        document.addEventListener('DOMContentLoaded', () => {
            // theme DOMContentLoaded
            const toggleButton = document.getElementById('theme-toggle');
            // theme toggle found? (silenced)
            if (toggleButton) {
                toggleButton.addEventListener('click', () => {
                    // theme toggled
                    ThemeManager.toggle();
                });
            }
        });
    </script>

    <script type="module" src="../neighborhoods/js/app.js?v=202503"></script>



    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjwVlnRslcTnR8d0Ocj3zYdj4CqFkIv9E&callback=initMap&v=weekly&libraries=marker,geometry"></script>
</body>
</html>
